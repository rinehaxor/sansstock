---
export const prerender = false;

import Layout from '../layouts/Layout.astro';
import MarketTicker from '../components/MarketTicker.astro';
import FeaturedNews from '../components/FeaturedNews.astro';
import MarketOverview from '../components/MarketOverview.astro';
import NewsList from '../components/NewsList.astro';
import CategoryTabs from '../components/CategoryTabs.tsx';
import { supabase } from '../db/supabase';
import { cache, CACHE_KEYS } from '../lib/cache';
import { getMarketData } from '../lib/market';
import { batchGetAltText } from '../lib/utils';

// OPTIMASI: Parallel fetch untuk semua independent data
// Ini mengurangi total waktu dari sequential ke parallel execution

// 1. Categories (dengan cache)
const categoriesPromise = cache.getOrSet(
  CACHE_KEYS.CATEGORIES,
  async () => {
    try {
      // First, get distinct category IDs that have published articles
      const { data: publishedCategoryIds } = await supabase
        .from('articles')
        .select('category_id')
        .eq('status', 'published')
        .not('category_id', 'is', null);

      if (publishedCategoryIds && publishedCategoryIds.length > 0) {
        // Extract unique category IDs
        const uniqueCategoryIds = [...new Set(publishedCategoryIds.map((a: any) => a.category_id))];

        // Fetch categories for those IDs
        const { data: categories } = await supabase
          .from('categories')
          .select('id, name, slug, description')
          .in('id', uniqueCategoryIds)
          .order('name', { ascending: true });

        return categories || [];
      }
      return [];
    } catch (error) {
      console.error('Error fetching categories:', error);
      // Fallback: fetch all categories if query fails
      const { data: allCategories } = await supabase
        .from('categories')
        .select('id, name, slug, description')
        .order('name', { ascending: true });
      return allCategories || [];
    }
  },
  5 * 60 * 1000 // Cache 5 menit
);

// 2. Market data (dengan cache, non-blocking)
// Gunakan Promise.race untuk tidak block jika lambat
const marketDataPromise = Promise.race([
  getMarketData(),
  new Promise<never>((_, reject) => 
    setTimeout(() => reject(new Error('Market data timeout')), 2000) // 2 second timeout
  )
]).catch(() => {
  // Fallback ke empty array jika timeout, component akan handle
  return [];
});

// 3. Featured articles (parallel dengan categories)
const featuredArticlesPromise = supabase
  .from('articles')
  .select(`
    id,
    title,
    slug,
    summary,
    thumbnail_url,
    published_at,
    categories:category_id (
      id,
      name,
      slug
    )
  `)
  .eq('status', 'published')
  .eq('featured', true)
  .order('published_at', { ascending: false })
  .limit(3);

// 4. News list (parallel)
const page = parseInt(Astro.url.searchParams.get('page') || '1');
const limit = 10;
const offset = (page - 1) * limit;
const newsListPromise = supabase
  .from('articles')
  .select(`
    id,
    title,
    slug,
    summary,
    thumbnail_url,
    published_at,
    created_at,
    views_count,
    categories:category_id (
      id,
      name,
      slug
    )
  `, { count: 'exact' })
  .eq('status', 'published')
  .order('published_at', { ascending: false })
  .range(offset, offset + limit - 1);

// Wait untuk semua parallel queries
const [availableCategories, marketData, featuredResult, newsListResult] = await Promise.all([
  categoriesPromise,
  marketDataPromise,
  featuredArticlesPromise,
  newsListResult,
]);

// Extract data dari results
const featuredArticles = featuredResult.data || [];
const newsArticles = newsListResult.data || [];
const newsCount = newsListResult.count || 0;
const totalPages = Math.ceil(newsCount / limit);

// Batch fetch alt text untuk semua articles sekaligus (parallel)
const allThumbnailUrls = [
  ...featuredArticles.map((a: any) => a.thumbnail_url),
  ...newsArticles.map((a: any) => a.thumbnail_url),
].filter(Boolean);

const allAltTextMap = await batchGetAltText(allThumbnailUrls);

// Map alt text ke articles
const featuredArticlesWithAlt = featuredArticles.map((article: any) => ({
  ...article,
  thumbnail_alt: article.thumbnail_url ? (allAltTextMap.get(article.thumbnail_url) || null) : null,
}));

const newsArticlesWithAlt = newsArticles.map((article: any) => ({
  ...article,
  thumbnail_alt: article.thumbnail_url ? (allAltTextMap.get(article.thumbnail_url) || null) : null,
}));

// Site URL akan otomatis detect dari environment variable atau request
const siteUrl = import.meta.env.SITE_URL || Astro.site?.href || (Astro.url ? `${Astro.url.protocol}//${Astro.url.host}` : 'http://localhost:4321');
const pageTitle = 'EmitenHub - Berita Ekonomi & Analisis Pasar Terpercaya';
const pageDescription = 'Portal berita ekonomi, saham, dan analisis pasar terpercaya. Dapatkan insight terbaru tentang pasar modal Indonesia, analisis saham, dan berita ekonomi terkini.';
const pageImage = `${siteUrl}/logo.png`;
---

<Layout 
	title={pageTitle}
	description={pageDescription}
	keywords="berita ekonomi, saham, pasar modal, analisis finansial, investasi, IHSG, rupiah, ekonomi Indonesia"
>
	<Fragment slot="head">
		{/* Robots Meta */}
		<meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1" />
		<meta name="googlebot" content="index, follow" />
		
		{/* Open Graph */}
		<meta property="og:type" content="website" />
		<meta property="og:title" content={pageTitle} />
		<meta property="og:description" content={pageDescription} />
		<meta property="og:image" content={pageImage} />
		<meta property="og:image:width" content="1200" />
		<meta property="og:image:height" content="630" />
		<meta property="og:url" content={siteUrl} />
		<meta property="og:site_name" content="EmitenHub" />
		<meta property="og:locale" content="id_ID" />
		
		{/* Twitter Card */}
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:title" content={pageTitle} />
		<meta name="twitter:description" content={pageDescription} />
		<meta name="twitter:image" content={pageImage} />
		
		{/* Canonical URL */}
		<link rel="canonical" href={siteUrl} />
		
		{/* Author & Publisher */}
		<meta name="author" content="EmitenHub" />
		<meta name="publisher" content="EmitenHub" />
		
		{/* Structured Data (JSON-LD) - Organization */}
		<script type="application/ld+json" set:html={JSON.stringify({
			"@context": "https://schema.org",
			"@type": "Organization",
			"name": "EmitenHub",
			"url": siteUrl,
			"logo": {
				"@type": "ImageObject",
				"url": `${siteUrl}/logo.png`,
				"width": 200,
				"height": 200
			},
			"sameAs": []
		})} />
		
		{/* Structured Data (JSON-LD) - WebSite */}
		<script type="application/ld+json" set:html={JSON.stringify({
			"@context": "https://schema.org",
			"@type": "WebSite",
			"name": "EmitenHub",
			"url": siteUrl,
			"description": pageDescription,
			"publisher": {
				"@type": "Organization",
				"name": "EmitenHub"
			},
			"potentialAction": {
				"@type": "SearchAction",
				"target": {
					"@type": "EntryPoint",
					"urlTemplate": `${siteUrl}/artikel?search={search_term_string}`
				},
				"query-input": "required name=search_term_string"
			},
			"mainEntity": {
				"@type": "SiteNavigationElement",
				"name": "Main Navigation",
				"url": siteUrl,
				"hasPart": [
					{
						"@type": "SiteNavigationElement",
						"name": "Artikel",
						"url": `${siteUrl}/artikel`
					},
					...availableCategories.slice(0, 5).map((category: any) => ({
						"@type": "SiteNavigationElement",
						"name": category.name,
						"url": `${siteUrl}/categories/${category.slug}`,
						"description": category.description || `Semua artikel tentang ${category.name}`
					}))
				]
			}
		})} />
		
		{/* Structured Data (JSON-LD) - BreadcrumbList for Homepage */}
		<script type="application/ld+json" set:html={JSON.stringify({
			"@context": "https://schema.org",
			"@type": "BreadcrumbList",
			"itemListElement": [{
				"@type": "ListItem",
				"position": 1,
				"name": "Beranda",
				"item": siteUrl
			}]
		})} />
	</Fragment>

	<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
	<MarketTicker />
	<FeaturedNews />
	<MarketOverview />
	<CategoryTabs 
		client:visible 
		categories={JSON.stringify(availableCategories)} 
		initialCategoryId={availableCategories && availableCategories.length > 0 ? availableCategories[0].id : undefined}
	/>
	<NewsList />
	</div>
</Layout>
