---
export const prerender = false;
---

<div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl shadow-lg mb-8 overflow-hidden" id="market-ticker-container">
  <div class="px-6 py-4">
    <div class="flex items-center justify-between mb-3">
      <div class="flex items-center gap-2">
        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
        </svg>
        <h3 class="text-white font-bold text-sm sm:text-base">Market Ticker</h3>
      </div>
      <div class="hidden sm:block">
        <span class="text-white/80 text-xs">Update Real-time</span>
      </div>
    </div>
    
    <div class="bg-white/10 backdrop-blur-sm rounded-lg overflow-hidden">
      <!-- Placeholder saat belum load -->
      <div id="market-ticker-placeholder" class="h-[60px] flex items-center justify-center">
        <div class="flex items-center gap-2 text-white/80">
          <div class="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
          <span class="text-sm">Memuat data pasar...</span>
        </div>
      </div>
      
      <!-- Iframe akan di-load saat visible -->
      <iframe
        id="market-ticker-iframe"
        title="Market Ticker"
        data-src={`https://pintu.co.id/widget/market-ticker?source=${Astro.url.origin}`}
        width="100%"
        height="60"
        style="border:none; border-radius:8px; overflow:hidden; background:transparent; display:none;"
        loading="lazy"
        class="w-full"
        sandbox="allow-scripts allow-same-origin allow-forms"
        referrerpolicy="no-referrer-when-downgrade"
        importance="low"
        allow="clipboard-read; clipboard-write"
        crossorigin="anonymous"
      ></iframe>
    </div>
  </div>
</div>

<script is:inline>
  // Lazy load Pintu widget dengan Intersection Observer
  // Ini mengurangi JavaScript execution time di initial load
  (function() {
    const container = document.getElementById('market-ticker-container');
    const placeholder = document.getElementById('market-ticker-placeholder');
    const iframe = document.getElementById('market-ticker-iframe');
    
    if (!container || !placeholder || !iframe) return;
    
    // Load iframe saat container visible di viewport
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const src = iframe.getAttribute('data-src');
          if (src && !iframe.src) {
            iframe.src = src;
            iframe.style.display = 'block';
            placeholder.style.display = 'none';
          }
          observer.unobserve(entry.target);
        }
      });
    }, {
      rootMargin: '50px' // Start loading 50px before visible
    });
    
    observer.observe(container);
    
    // Fallback: Load setelah 2 detik jika belum visible
    setTimeout(() => {
      if (!iframe.src) {
        const src = iframe.getAttribute('data-src');
        if (src) {
          iframe.src = src;
          iframe.style.display = 'block';
          placeholder.style.display = 'none';
          observer.disconnect();
        }
      }
    }, 2000);
  })();
</script>
