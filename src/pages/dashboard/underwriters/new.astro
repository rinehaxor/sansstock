---
export const prerender = false;

import AdminLayout from '../../../layouts/AdminLayout.astro';
import { supabase } from '../../../db/supabase';
import UnderwriterForm from '../../../components/UnderwriterForm';

const accessToken = Astro.cookies.get('sb-access-token');
const refreshToken = Astro.cookies.get('sb-refresh-token');

if (!accessToken || !refreshToken) {
  return Astro.redirect('/portal/access');
}

let session;

try {
  session = await supabase.auth.setSession({
    refresh_token: refreshToken.value,
    access_token: accessToken.value,
  });

  if (session.error) {
    Astro.cookies.delete('sb-access-token', { path: '/' });
    Astro.cookies.delete('sb-refresh-token', { path: '/' });
    return Astro.redirect('/portal/access');
  }
} catch (error) {
  Astro.cookies.delete('sb-access-token', { path: '/' });
  Astro.cookies.delete('sb-refresh-token', { path: '/' });
  return Astro.redirect('/portal/access');
}

const email = session.data.user?.email;
---

<AdminLayout title="Underwriter Baru" email={email}>
	<div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
		<div class="flex items-center justify-between mb-8">
			<div>
				<h1 class="text-3xl font-bold text-gray-900">Tambah Underwriter Baru</h1>
				<p class="mt-2 text-sm text-gray-600">Tambahkan underwriter baru ke sistem</p>
			</div>
			<a href="/dashboard/underwriters" class="text-sm text-gray-600 hover:text-gray-900">
				&larr; Kembali ke daftar
			</a>
		</div>

		<UnderwriterForm client:load mode="create" />
	</div>
</AdminLayout>

