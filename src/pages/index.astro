---
// Tetap SSR untuk dynamic content
// Optimasi dilakukan dengan: cache, parallel queries, dan warmup
export const prerender = false;

import Layout from '../layouts/Layout.astro';
import MarketTicker from '../components/MarketTicker.astro';
import FeaturedNews from '../components/FeaturedNews.astro';
import MarketOverview from '../components/MarketOverview.astro';
import NewsList from '../components/NewsList.astro';
import { supabase } from '../db/supabase';
import { cache, CACHE_KEYS } from '../lib/cache';
import { getMarketData } from '../lib/market';
import { batchGetAltText, getOptimizedImageUrl } from '../lib/utils';

// OPTIMASI: Parallel fetch untuk semua independent data
// Ini mengurangi total waktu dari sequential ke parallel execution

// 1. Categories (dengan cache)
const categoriesPromise = cache.getOrSet(
  CACHE_KEYS.CATEGORIES,
  async () => {
    try {
      // First, get distinct category IDs that have published articles
      const { data: publishedCategoryIds } = await supabase
        .from('articles')
        .select('category_id')
        .eq('status', 'published')
        .not('category_id', 'is', null);

      if (publishedCategoryIds && publishedCategoryIds.length > 0) {
        // Extract unique category IDs
        const uniqueCategoryIds = [...new Set(publishedCategoryIds.map((a: any) => a.category_id))];

        // Fetch categories for those IDs
        const { data: categories } = await supabase
          .from('categories')
          .select('id, name, slug, description')
          .in('id', uniqueCategoryIds)
          .order('name', { ascending: true });

        return categories || [];
      }
      return [];
    } catch (error) {
      console.error('Error fetching categories:', error);
      // Fallback: fetch all categories if query fails
      const { data: allCategories } = await supabase
        .from('categories')
        .select('id, name, slug, description')
        .order('name', { ascending: true });
      return allCategories || [];
    }
  },
  5 * 60 * 1000 // Cache 5 menit
);

// 2. Market data (dengan cache, non-blocking)
// Gunakan Promise.race untuk tidak block jika lambat
const marketDataPromise = Promise.race([
  getMarketData(),
  new Promise<never>((_, reject) => 
    setTimeout(() => reject(new Error('Market data timeout')), 2000) // 2 second timeout
  )
]).catch(() => {
  // Fallback ke empty array jika timeout, component akan handle
  return [];
});

// 3. Featured articles (parallel dengan categories)
const featuredArticlesPromise = supabase
  .from('articles')
  .select(`
    id,
    title,
    slug,
    summary,
    thumbnail_url,
    published_at,
    categories:category_id (
      id,
      name,
      slug
    )
  `)
  .eq('status', 'published')
  .eq('featured', true)
  .order('published_at', { ascending: false })
  .limit(3);

// 4. News list (parallel)
const page = parseInt(Astro.url.searchParams.get('page') || '1');
const limit = 10;
const offset = (page - 1) * limit;
const newsListPromise = supabase
  .from('articles')
  .select(`
    id,
    title,
    slug,
    summary,
    thumbnail_url,
    published_at,
    created_at,
    views_count,
    categories:category_id (
      id,
      name,
      slug
    )
  `, { count: 'exact' })
  .eq('status', 'published')
  .order('published_at', { ascending: false })
  .range(offset, offset + limit - 1);

// Wait untuk semua parallel queries
const [availableCategories, marketData, featuredResult, newsListResult] = await Promise.all([
  categoriesPromise,
  marketDataPromise,
  featuredArticlesPromise,
  newsListPromise, // Fix: gunakan newsListPromise, bukan newsListResult
]);

// Extract data dari results
const featuredArticles = featuredResult.data || [];
const newsArticles = newsListResult.data || [];
const newsCount = newsListResult.count || 0;
const totalPages = Math.ceil(newsCount / limit);

// Batch fetch alt text untuk semua articles sekaligus (parallel)
const allThumbnailUrls = [
  ...featuredArticles.map((a: any) => a.thumbnail_url),
  ...newsArticles.map((a: any) => a.thumbnail_url),
].filter(Boolean);

const allAltTextMap = await batchGetAltText(allThumbnailUrls);

// Map alt text ke articles
const featuredArticlesWithAlt = featuredArticles.map((article: any) => ({
  ...article,
  thumbnail_alt: article.thumbnail_url ? (allAltTextMap.get(article.thumbnail_url) || null) : null,
}));

const newsArticlesWithAlt = newsArticles.map((article: any) => ({
  ...article,
  thumbnail_alt: article.thumbnail_url ? (allAltTextMap.get(article.thumbnail_url) || null) : null,
}));

// Site URL akan otomatis detect dari environment variable atau request
const siteUrl = import.meta.env.SITE_URL || Astro.site?.href || (Astro.url ? `${Astro.url.protocol}//${Astro.url.host}` : 'http://localhost:4321');
const pageTitle = 'EmitenHub - Berita Ekonomi & Analisis Pasar Terpercaya';
const pageDescription = 'Portal berita ekonomi, saham, dan analisis pasar terpercaya. Dapatkan insight terbaru tentang pasar modal Indonesia, analisis saham, dan berita ekonomi terkini.';
const pageImage = `${siteUrl}/logo.png`;

// Generate LCP image preload URL for featured article
// Skip preload untuk external images (Unsplash) karena tidak bisa di-optimize via _image
function getLCPPreloadUrl(thumbnailUrl: string | null | undefined): string | null {
	if (!thumbnailUrl) return null;
	
	// Skip preload untuk external images (Unsplash, dll) untuk avoid 403 errors
	try {
		const url = new URL(thumbnailUrl);
		const isSupabase = url.hostname.includes('supabase.co') || url.hostname.includes('supabase.storage');
		if (!isSupabase) {
			// Tidak preload external images karena tidak bisa di-optimize
			return null;
		}
	} catch {
		// Invalid URL, skip preload
		return null;
	}
	
	// Hanya preload Supabase images
	try {
		const params = new URLSearchParams();
		params.set('href', encodeURI(thumbnailUrl));
		params.set('w', '800');
		params.set('h', '343');
		params.set('q', '75');
		params.set('f', 'webp');
		return `/_image?${params.toString()}`;
	} catch {
		return null;
	}
}

const lcpImageUrl = featuredArticlesWithAlt && featuredArticlesWithAlt.length > 0
	? getLCPPreloadUrl(featuredArticlesWithAlt[0].thumbnail_url)
	: null;
---

<Layout 
	title={pageTitle}
	description={pageDescription}
	keywords="berita ekonomi, saham, pasar modal, analisis finansial, investasi, IHSG, rupiah, ekonomi Indonesia"
>
	<Fragment slot="head">
		{/* Preload LCP image for faster rendering */}
		{lcpImageUrl && (
			<link rel="preload" as="image" href={lcpImageUrl} fetchpriority="high" />
		)}
		
		{/* Preload initial category articles API request */}
		{availableCategories && availableCategories.length > 0 && (
			<link rel="prefetch" href={`/api/articles?category_id=${availableCategories[0].id}&status=published&limit=4`} as="fetch" crossorigin="anonymous" />
		)}
		
		{/* Robots Meta */}
		<meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1" />
		<meta name="googlebot" content="index, follow" />
		
		{/* Open Graph */}
		<meta property="og:type" content="website" />
		<meta property="og:title" content={pageTitle} />
		<meta property="og:description" content={pageDescription} />
		<meta property="og:image" content={pageImage} />
		<meta property="og:image:width" content="1200" />
		<meta property="og:image:height" content="630" />
		<meta property="og:url" content={siteUrl} />
		<meta property="og:site_name" content="EmitenHub" />
		<meta property="og:locale" content="id_ID" />
		
		{/* Twitter Card */}
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:title" content={pageTitle} />
		<meta name="twitter:description" content={pageDescription} />
		<meta name="twitter:image" content={pageImage} />
		
		{/* Canonical URL */}
		<link rel="canonical" href={siteUrl} />
		
		{/* Author & Publisher */}
		<meta name="author" content="EmitenHub" />
		<meta name="publisher" content="EmitenHub" />
		
		{/* Structured Data (JSON-LD) - Organization */}
		{false && (() => {
			const orgData = {
				"@context": "https://schema.org",
				"@type": "Organization",
				"name": "EmitenHub",
				"url": siteUrl,
				"logo": {
					"@type": "ImageObject",
					"url": `${siteUrl}/logo.png`,
					"width": 200,
					"height": 200
				},
				"sameAs": []
			};
			return <script type="application/ld+json" set:html={JSON.stringify(orgData)} />;
		})()}
		
		{/* Structured Data (JSON-LD) - WebSite */}
		{false && (() => {
			const categoryNavItems = availableCategories && availableCategories.length > 0 
				? availableCategories.slice(0, 5).map((category: any) => ({
					"@type": "SiteNavigationElement",
					"name": category.name || "Category",
					"url": `${siteUrl}/categories/${category.slug || ""}`,
					"description": category.description || `Semua artikel tentang ${category.name || "category"}`
				}))
				: [];
			
			const websiteData = {
				"@context": "https://schema.org",
				"@type": "WebSite",
				"name": "EmitenHub",
				"url": siteUrl,
				"description": pageDescription,
				"publisher": {
					"@type": "Organization",
					"name": "EmitenHub"
				},
				"potentialAction": {
					"@type": "SearchAction",
					"target": {
						"@type": "EntryPoint",
						"urlTemplate": `${siteUrl}/artikel?search={search_term_string}`
					},
					"query-input": "required name=search_term_string"
				},
				"mainEntity": {
					"@type": "SiteNavigationElement",
					"name": "Main Navigation",
					"url": siteUrl,
					"hasPart": [
						{
							"@type": "SiteNavigationElement",
							"name": "Artikel",
							"url": `${siteUrl}/artikel`
						},
						...categoryNavItems
					]
				}
			};
			return <script type="application/ld+json" set:html={JSON.stringify(websiteData)} />;
		})()}
		
		{/* Structured Data (JSON-LD) - BreadcrumbList for Homepage */}
		{false && (() => {
			const breadcrumbData = {
				"@context": "https://schema.org",
				"@type": "BreadcrumbList",
				"itemListElement": [{
					"@type": "ListItem",
					"position": 1,
					"name": "Beranda",
					"item": siteUrl
				}]
			};
			return <script type="application/ld+json" set:html={JSON.stringify(breadcrumbData)} />;
		})()}
	</Fragment>

	<div class="max-w-7xl mx-auto px-3 sm:px-4 lg:px-6 xl:px-8 py-4 sm:py-6 lg:py-8">
	<!-- <MarketTicker /> -->
	<FeaturedNews />
	<MarketOverview />

	<section class="mb-16" data-category-tabs>
		<div class="border-b border-gray-200 mb-6 overflow-x-auto -mx-4 sm:-mx-6 lg:-mx-8 px-4 sm:px-6 lg:px-8">
			<div class="inline-flex h-auto w-full justify-start bg-transparent p-0 space-x-1">
				{Array.isArray(availableCategories) && availableCategories.length > 0 ? (
					availableCategories.map((category) => (
						<button
							data-category-tab
							data-category-id={category.id}
							class="px-3 py-2 sm:px-4 sm:py-3 text-xs sm:text-sm font-medium whitespace-nowrap border-b-2 rounded-none border-transparent text-gray-600 hover:text-gray-900 hover:border-gray-300"
							type="button"
						>
							{category.name}
						</button>
					))
				) : (
					<p class="text-gray-500 text-sm">Tidak ada kategori.</p>
				)}
			</div>
		</div>

		<div id="category-articles" class="mt-0" style="min-height: 400px;">
			<div class="flex items-center justify-center py-12">
				<div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-blue-600 border-t-transparent"></div>
				<p class="ml-3 text-gray-600 text-sm sm:text-base">Memuat artikel...</p>
			</div>
		</div>
	</section>

	<NewsList />
	</div>

	<script is:inline define:vars={{ 
		categories: availableCategories || [], 
		initialCategoryId: availableCategories && availableCategories.length > 0 ? availableCategories[0].id : null 
	}}>
	(function () {
		if (!Array.isArray(categories) || categories.length === 0) {
			return;
		}

		var tabsRoot = document.querySelector('[data-category-tabs]');
		if (!tabsRoot) return;

		var buttons = Array.prototype.slice.call(
			tabsRoot.querySelectorAll('[data-category-tab]')
		);

		var articlesContainer = document.getElementById('category-articles');
		if (!articlesContainer) return;

		var activeCategoryId = initialCategoryId || (categories[0] && categories[0].id);
		var cache = {};

		function setActiveButton(categoryId) {
			buttons.forEach(function (btn) {
				var id = Number(btn.getAttribute('data-category-id') || '0');
				if (id === categoryId) {
					btn.classList.add('border-b-2', 'border-blue-600', 'text-blue-600');
				} else {
					btn.classList.remove('border-b-2', 'border-blue-600', 'text-blue-600');
				}
			});
		}

		function renderLoading() {
			articlesContainer.innerHTML =
				'<div class="flex items-center justify-center py-12">' +
				'<div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-blue-600 border-t-transparent"></div>' +
				'<p class="ml-3 text-gray-600 text-sm sm:text-base">Memuat artikel...</p>' +
				'</div>';
		}

		function renderError(message) {
			articlesContainer.innerHTML =
				'<div class="bg-yellow-50 border border-yellow-200 rounded-xl p-8 sm:p-12 text-center">' +
				'<p class="text-yellow-800 text-sm sm:text-lg mb-2">Error memuat artikel</p>' +
				'<p class="text-yellow-600 text-xs sm:text-sm">' + (message || 'Gagal memuat artikel') + '</p>' +
				'</div>';
		}

		function escapeHtml(value) {
			if (!value) return '';
			return String(value)
				.replace(/&/g, '&amp;')
				.replace(/</g, '&lt;')
				.replace(/>/g, '&gt;')
				.replace(/"/g, '&quot;')
				.replace(/'/g, '&#39;');
		}

		function renderEmpty() {
			articlesContainer.innerHTML =
				'<div class="bg-white rounded-xl border border-gray-200 p-8 sm:p-12 text-center">' +
				'<p class="text-gray-500 text-sm sm:text-lg">Belum ada artikel untuk kategori ini.</p>' +
				'</div>';
		}

			function renderArticles(articles) {
				if (!Array.isArray(articles) || articles.length === 0) {
					renderEmpty();
					return;
				}

				// Reserve space before rendering to prevent layout shift
				var container = articlesContainer;
				var currentHeight = 0;
				if (container) {
					currentHeight = container.offsetHeight || 400; // Fallback to 400px if 0
					container.style.minHeight = currentHeight + 'px';
				}

				var itemsHtml = articles.map(function (article) {
				var title = escapeHtml(article.title || '');
				var summary = escapeHtml(article.summary || 'Tidak ada ringkasan tersedia...');
				var slug = escapeHtml(article.slug || '');
				var thumbnailUrl = article.thumbnail_url ? escapeHtml(article.thumbnail_url) : '';
				var thumbnailAlt = escapeHtml(article.thumbnail_alt || article.title || 'Article thumbnail');
				var categoryName = article.categories && article.categories.name ? escapeHtml(article.categories.name) : 'Umum';
				var categorySlug = article.categories && article.categories.slug ? escapeHtml(article.categories.slug) : '';
				var articleUrl = '/artikel/' + slug;
				var categoryUrl = categorySlug ? ('/categories/' + categorySlug) : '';

				var dateString = article.published_at || article.created_at;
				var timeAgo = 'Baru saja';
				if (dateString) {
					var date = new Date(dateString);
					var now = new Date();
					var diffInSeconds = Math.floor((now.getTime() - date.getTime()) / 1000);
					if (diffInSeconds >= 60) {
						if (diffInSeconds < 3600) {
							timeAgo = Math.floor(diffInSeconds / 60) + ' menit yang lalu';
						} else if (diffInSeconds < 86400) {
							timeAgo = Math.floor(diffInSeconds / 3600) + ' jam yang lalu';
						} else if (diffInSeconds < 604800) {
							timeAgo = Math.floor(diffInSeconds / 86400) + ' hari yang lalu';
						} else if (diffInSeconds < 2592000) {
							timeAgo = Math.floor(diffInSeconds / 604800) + ' minggu yang lalu';
						} else {
							timeAgo = Math.floor(diffInSeconds / 2592000) + ' bulan yang lalu';
						}
					}
				}

				var metaLine = categorySlug
					? '<a href="' + categoryUrl + '" class="hover:underline">' + categoryName + '</a> | ' + timeAgo
					: categoryName + ' | ' + timeAgo;

				var imageHtml;
				if (thumbnailUrl) {
					// Client-side image optimization helper
					function getOptimizedImageUrlClient(url, width, height) {
						if (!url) return null;
						if (url.startsWith('/_image?')) return url;
						if (url.startsWith('/')) return url;
						
						// Skip optimization untuk external images (Unsplash, dll) untuk avoid 403 errors
						try {
							var urlObj = new URL(url);
							var isSupabase = urlObj.hostname.includes('supabase.co') || urlObj.hostname.includes('supabase.storage');
							if (!isSupabase) {
								// Return original URL untuk external images
								return url;
							}
						} catch (e) {
							// Invalid URL, return as-is
							return url;
						}
						
						// Hanya optimize Supabase images
						var params = new URLSearchParams();
						params.set('href', encodeURI(url));
						params.set('w', String(width || 192));
						if (height) params.set('h', String(height));
						params.set('q', '75');
						params.set('f', 'webp');
						return '/_image?' + params.toString();
					}
					var optimizedUrl = getOptimizedImageUrlClient(thumbnailUrl, 192, 112) || thumbnailUrl;
					imageHtml =
						'<img src="' + optimizedUrl + '" alt="' + thumbnailAlt + '"' +
						' class="w-full sm:w-48 h-48 sm:h-28 rounded-lg object-cover" loading="lazy"' +
						' width="192" height="112" decoding="async" fetchpriority="low"' +
						' sizes="(max-width: 640px) 100vw, 192px" style="aspect-ratio: 192/112" />';
				} else {
					imageHtml =
						'<div class="w-full sm:w-48 h-48 sm:h-28 rounded-lg bg-gradient-to-br from-gray-400 to-gray-500 flex items-center justify-center">' +
						'<svg class="w-12 h-12 text-white opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
						'<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path>' +
						'</svg>' +
						'</div>';
				}

				return (
					'<article class="group bg-white rounded-xl border border-gray-200 p-4 sm:p-6 hover:shadow-md transition-shadow">' +
					'<div class="flex flex-col sm:flex-row gap-4 sm:gap-6">' +
					'<a href="' + articleUrl + '" class="flex-shrink-0 w-full sm:w-48">' +
					imageHtml +
					'</a>' +
					'<div class="flex-1 min-w-0">' +
					'<a href="' + articleUrl + '" class="block">' +
					'<h3 class="text-lg sm:text-xl font-bold text-gray-900 group-hover:text-blue-600 mb-2 leading-tight">' +
					title +
					'</h3>' +
					'<p class="text-sm text-gray-600 mb-3 line-clamp-2 sm:line-clamp-2">' +
					summary +
					'</p>' +
					'</a>' +
					'<p class="text-xs sm:text-sm text-blue-600 font-medium">' +
					metaLine +
					'</p>' +
					'</div>' +
					'</div>' +
					'</article>'
				);
			}).join('');

			articlesContainer.innerHTML =
				'<div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">' +
				itemsHtml +
				'</div>';
			
			// Reset min-height after a short delay to allow layout to settle
			if (container) {
				setTimeout(function() {
					if (container) {
						container.style.minHeight = '';
					}
				}, 100);
			}
		}

		async function fetchArticles(categoryId) {
			if (!categoryId) return;

			if (cache[categoryId]) {
				renderArticles(cache[categoryId]);
				setActiveButton(categoryId);
				return;
			}

			renderLoading();
			setActiveButton(categoryId);

			try {
				var params = new URLSearchParams();
				params.set('category_id', String(categoryId));
				params.set('status', 'published');
				params.set('limit', '4');

				var response = await fetch('/api/articles?' + params.toString());
				if (!response.ok) throw new Error('HTTP ' + response.status);

				var result = await response.json();
				var articles = Array.isArray(result.data)
					? result.data
					: (Array.isArray(result.articles) ? result.articles : []);

				cache[categoryId] = articles;
				renderArticles(articles);
			} catch (error) {
				console.error('Error fetching articles:', error);
				renderError(error && error.message ? error.message : 'Gagal memuat artikel');
			}
		}

		buttons.forEach(function (btn) {
			btn.addEventListener('click', function () {
				var idAttr = btn.getAttribute('data-category-id');
				var id = Number(idAttr || '0');
				if (!id || id === activeCategoryId) return;
				activeCategoryId = id;
				fetchArticles(id);
			});
		});

		// Defer initial fetch to avoid blocking critical rendering
		// Wait for page to be fully interactive before fetching
		function scheduleInitialFetch() {
			// Wait for load event + additional delay to ensure critical resources are loaded
			if (document.readyState === 'complete') {
				// Page already loaded, wait a bit more
				setTimeout(function() {
					if (activeCategoryId) {
						fetchArticles(activeCategoryId);
					}
				}, 500);
			} else {
				// Wait for page load, then additional delay
				window.addEventListener('load', function() {
					setTimeout(function() {
						if (activeCategoryId) {
							fetchArticles(activeCategoryId);
						}
					}, 500);
				}, { once: true });
			}
		}
		
		if (activeCategoryId) {
			scheduleInitialFetch();
		}
	})();
	</script>
</Layout>
