---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import { supabase } from '../../db/supabase';
import UnderwriterComparison from '../../components/UnderwriterComparison.tsx';

// Fetch underwriters along with IPO listings and performance metrics
const { data: underwriters, error } = await supabase
  .from('underwriters')
  .select(`
    id,
    name,
    ipo_underwriters:ipo_underwriters (
      ipo_listing:ipo_listings (
        id,
        ticker_symbol,
        company_name,
        ipo_date,
        ipo_price,
        general_sector,
        specific_sector,
        ipo_performance_metrics:ipo_performance_metrics (
          metric_name,
          metric_value,
          period_days
        ),
        ipo_underwriters:ipo_underwriters (
          underwriter:underwriters (
            id,
            name
          )
        )
      )
    )
  `)
  .order('name', { ascending: true });

if (error) {
  console.error('Error fetching underwriters:', error);
}

const underwritersWithStats =
  (underwriters || []).map((underwriter: any) => {
    const ipoUnderwriters = underwriter.ipo_underwriters || [];
    const ipoListings = ipoUnderwriters
      .map((item: any) => item.ipo_listing)
      .filter((item: any) => item !== null)
      .map((ipo: any) => ({
        id: ipo.id,
        ticker_symbol: ipo.ticker_symbol,
        company_name: ipo.company_name,
        ipo_date: ipo.ipo_date,
        ipo_price: ipo.ipo_price,
        general_sector: ipo.general_sector,
        specific_sector: ipo.specific_sector,
        ipo_performance_metrics: ipo.ipo_performance_metrics || [],
        underwriters: (ipo.ipo_underwriters || [])
          .map((item: any) => item.underwriter)
          .filter((uw: any) => uw && uw.id && uw.name),
      }));

    const allMetrics: any[] = [];
    ipoListings.forEach((ipo: any) => {
      const metrics = ipo.ipo_performance_metrics || [];
      allMetrics.push(...metrics);
    });

    const metricsByPeriod: Record<number, number[]> = {};
    allMetrics.forEach((metric: any) => {
      if (metric.period_days && metric.metric_value !== null) {
        if (!metricsByPeriod[metric.period_days]) {
          metricsByPeriod[metric.period_days] = [];
        }
        metricsByPeriod[metric.period_days].push(metric.metric_value);
      }
    });

    const performanceByPeriod: Record<
      number,
      { avg: number; min: number; max: number; count: number }
    > = {};
    Object.keys(metricsByPeriod).forEach((period) => {
      const values = metricsByPeriod[parseInt(period)];
      const avg = values.reduce((a, b) => a + b, 0) / values.length;
      performanceByPeriod[parseInt(period)] = {
        avg: parseFloat(avg.toFixed(2)),
        min: Math.min(...values),
        max: Math.max(...values),
        count: values.length,
      };
    });

    return {
      id: underwriter.id,
      name: underwriter.name,
      total_ipos: ipoListings.length,
      performance_by_period: performanceByPeriod,
      ipo_listings: ipoListings,
    };
  }) || [];

const underwritersList = underwritersWithStats;
---

<Layout 
	title="Analisis Performa Underwriter - EmitenHub"
	description="Analisis performa gabungan dari  underwriter IPO. Bandingkan performa ketika 1-3 underwriter bekerja sama menangani IPO."
	keywords="analisis underwriter,  underwriter, performa IPO, perbandingan underwriter, BEI, IHSG"
>
	<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
		<!-- Breadcrumb -->
		<div class="mb-6">
			<div class="flex items-center gap-2 text-sm text-gray-500">
				<a href="/" class="hover:text-gray-700">Beranda</a>
				<span>/</span>
				<a href="/underwriters" class="hover:text-gray-700">Underwriter IPO</a>
				<span>/</span>
				<span>Analisis Underwriter</span>
			</div>
		</div>

		<!-- Header -->
		<div class="mb-6 sm:mb-8">
			<h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-gray-900 mb-2 sm:mb-3">Analisis Performa  Underwriter</h1>
			<p class="text-sm sm:text-base lg:text-lg text-gray-600">
				Pilih satu atau lebih underwriter untuk melihat performa gabungan. Sistem akan menghitung rata-rata performa dari masing-masing underwriter, 
				lalu menggabungkannya menjadi satu nilai performa gabungan. Tidak perlu IPO yang sama, cukup rata-rata performa masing-masing.
			</p>
		</div>

		<!-- Info Box -->
		<div class="bg-blue-50 border border-blue-200 rounded-lg p-3 sm:p-4 mb-6 sm:mb-8">
			<div class="flex items-start gap-2 sm:gap-3">
				<svg class="w-4 h-4 sm:w-5 sm:h-5 text-blue-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
					<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
				</svg>
				<div class="text-xs sm:text-sm text-blue-800">
					<p class="font-medium mb-1">Cara Menggunakan:</p>
					<ul class="list-disc list-inside space-y-0.5 sm:space-y-1 text-blue-700">
						<li>Klik "Tambah Underwriter" untuk menambah slot dropdown</li>
						<li>Pilih underwriter dari dropdown yang tersedia</li>
						<li>Indikator warna menunjukkan apakah performa bagus (hijau) atau kurang bagus (merah)</li>
					</ul>
				</div>
			</div>
		</div>

		<!-- Comparison Component -->
        <UnderwriterComparison 
        underwriters={underwritersList}
      />
	</div>
</Layout>

