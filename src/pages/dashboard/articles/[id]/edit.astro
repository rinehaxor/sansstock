---
export const prerender = false;

import AdminLayout from '../../../../layouts/AdminLayout.astro';
import { supabase } from '../../../../db/supabase';
import ArticleForm from '../../../../components/ArticleForm.tsx';

const accessToken = Astro.cookies.get('sb-access-token');
const refreshToken = Astro.cookies.get('sb-refresh-token');

if (!accessToken || !refreshToken) {
  return Astro.redirect('/portal/access');
}

let session;

try {
  session = await supabase.auth.setSession({
    refresh_token: refreshToken.value,
    access_token: accessToken.value,
  });

  if (session.error) {
    Astro.cookies.delete('sb-access-token', { path: '/' });
    Astro.cookies.delete('sb-refresh-token', { path: '/' });
    return Astro.redirect('/portal/access');
  }
} catch (error) {
  Astro.cookies.delete('sb-access-token', { path: '/' });
  Astro.cookies.delete('sb-refresh-token', { path: '/' });
  return Astro.redirect('/portal/access');
}

const email = session.data.user?.email;
const articleId = parseInt(Astro.params.id || '0');

if (isNaN(articleId) || articleId === 0) {
  return Astro.redirect('/dashboard/articles');
}

// Fetch article
const { data: article, error: articleError } = await supabase
  .from('articles')
  .select(`
    *,
    article_tags (
      tag_id
    )
  `)
  .eq('id', articleId)
  .single();

if (articleError || !article) {
  return Astro.redirect('/dashboard/articles');
}

// Fetch categories, sources, and tags
const { data: categories } = await supabase
  .from('categories')
  .select('id, name')
  .order('name');

const { data: sources } = await supabase
  .from('sources')
  .select('id, name')
  .eq('is_active', true)
  .order('name');

const { data: tags } = await supabase
  .from('tags')
  .select('id, name')
  .order('name');

// Get selected tag IDs
const selectedTagIds = article.article_tags?.map((at: any) => at.tag_id) || [];
---

<AdminLayout title="Edit Artikel" email={email}>
	<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
		<!-- Header -->
		<div class="mb-8">
			<div class="flex items-center justify-between">
				<div>
					<h1 class="text-3xl font-bold text-gray-900">Edit Artikel</h1>
					<p class="mt-2 text-sm text-gray-600">Ubah informasi artikel</p>
				</div>
				<a 
					href="/dashboard/articles"
					class="text-sm text-gray-600 hover:text-gray-900"
				>
					â† Kembali ke Daftar Artikel
				</a>
			</div>
		</div>

		<!-- Form -->
		<ArticleForm
			client:load
			mode="edit"
			articleId={articleId}
			initialArticle={article}
			categories={categories || []}
			sources={sources || []}
			tags={tags || []}
			selectedTagIds={selectedTagIds}
		/>
</AdminLayout>
