---
export const prerender = false;

import { supabase } from '../db/supabase';
import PopularNews from './PopularNews.astro';
import AdsWidget from './AdsWidget.astro';
import NewsListClient from './NewsListClient.tsx';
import NewsCard from './NewsCard.astro';

// Get page from URL query parameter
const page = parseInt(Astro.url.searchParams.get('page') || '1');
const limit = 10;
const offset = (page - 1) * limit;

// Fetch published articles with pagination for initial load
const { data: articles, error, count } = await supabase
  .from('articles')
  .select(`
    id,
    title,
    slug,
    summary,
    thumbnail_url,
    published_at,
    created_at,
    views_count,
    categories:category_id (
      id,
      name,
      slug
    )
  `, { count: 'exact' })
  .eq('status', 'published')
  .order('published_at', { ascending: false })
  .range(offset, offset + limit - 1);

// Calculate total pages
const totalArticles = count || 0;
const totalPages = Math.ceil(totalArticles / limit);

// Helper function untuk get alt text dari media_metadata
async function getAltText(thumbnailUrl: string | null): Promise<string | null> {
  if (!thumbnailUrl) return null;
  
  try {
    const { data: mediaMetadata } = await supabase
      .from('media_metadata')
      .select('alt_text')
      .eq('file_url', thumbnailUrl)
      .single();
    
    return mediaMetadata?.alt_text || null;
  } catch (e) {
    return null;
  }
}

// Get alt text untuk semua artikel dari media_metadata
const articlesWithAltText = await Promise.all(
  (articles || []).map(async (article: any) => {
    const altText = await getAltText(article.thumbnail_url);
    return {
      ...article,
      thumbnail_alt: altText,
    };
  })
);
---

<section class="mb-16">
	<div class="flex items-center justify-between mb-8">
		<h2 class="text-3xl font-bold text-gray-900">Terkini</h2>
		<a href="/artikel" class="text-blue-600 hover:text-blue-700 font-medium flex items-center group">
			Lihat Semua
			<svg class="w-4 h-4 ml-1 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
			</svg>
		</a>
	</div>
	
	<div class="grid lg:grid-cols-3 gap-8">
		<!-- Main News Content -->
		<div class="lg:col-span-2">
			<!-- Initial Articles (Server-side rendered with Astro Image) -->
			<div id="news-list-section" class="space-y-6">
				{articlesWithAltText && articlesWithAltText.length > 0 ? (
					articlesWithAltText.map((article: any) => (
						<NewsCard
							id={article.id}
							title={article.title}
							slug={article.slug}
							summary={article.summary}
							thumbnail_url={article.thumbnail_url}
							thumbnail_alt={article.thumbnail_alt}
							published_at={article.published_at}
							created_at={article.created_at}
							categories={article.categories}
						/>
					))
				) : (
					<div class="bg-white rounded-xl border border-gray-200 p-12 text-center">
						<p class="text-gray-500 text-lg">Belum ada artikel yang diterbitkan.</p>
						<p class="text-gray-400 text-sm mt-2">Silakan publikasikan artikel dari dashboard admin.</p>
					</div>
				)}
			</div>
			
			<!-- Pagination and Client-side Loading -->
			<NewsListClient 
				client:load
				initialPage={page}
				initialArticles={articlesWithAltText}
				initialTotalPages={totalPages}
				initialTotalArticles={totalArticles}
			/>
		</div>
		
		<!-- Popular News Sidebar -->
		<div class="lg:col-span-1">
			<PopularNews />
			<AdsWidget />
			<!-- Market Ticker Widget -->
			<div class="mt-6">
				<iframe
					title="Market Ticker"
					src={`https://pintu.co.id/widget/market-ticker?source=${Astro.url.origin}`}
					width="100%"
					height="50"
					style="border:none; border-radius:8px; overflow:hidden;"
					loading="lazy"
				></iframe>
			</div>
		</div>
	</div>
</section>
