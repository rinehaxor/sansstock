---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import { supabase } from '../../db/supabase';
import PopularNews from '../../components/PopularNews.astro';
import ArticleCard from '../../components/ArticleCard.astro';
import NewsPagination from '../../components/NewsPagination.tsx';

const { slug } = Astro.params;

// Fetch tag by slug
const { data: tag, error: tagError } = await supabase
   .from('tags')
   .select('id, name, slug, description')
   .eq('slug', slug)
   .single();

if (tagError || !tag) {
   return new Response('Tag not found', { status: 404 });
}

// Site URL akan otomatis detect dari environment variable atau request
const siteUrl = import.meta.env.SITE_URL || Astro.site?.href || (Astro.url ? `${Astro.url.protocol}//${Astro.url.host}` : 'http://localhost:4321');
const tagUrl = `${siteUrl}/tags/${tag.slug}`;
const pageTitle = `${tag.name} - SansStocks`;
const pageDescription = tag.description || `Semua artikel dengan tag ${tag.name} di SansStocks. Temukan berita dan analisis terkait ${tag.name}.`;
const pageImage = `${siteUrl}/logo.png`;

// Fetch 3 latest articles from this tag for featured section
// First, get article_ids from article_tags
const { data: featuredArticleTags } = await supabase
   .from('article_tags')
   .select('article_id')
   .eq('tag_id', tag.id);

const featuredArticleIds = featuredArticleTags?.map((at: any) => at.article_id) || [];

let featuredArticles: any[] = [];
if (featuredArticleIds.length > 0) {
   const { data: featuredArticlesData } = await supabase
      .from('articles')
      .select(`
         id,
         title,
         slug,
         summary,
         thumbnail_url,
         published_at,
         created_at,
         category_id,
         categories:category_id (
            id,
            name,
            slug
         )
      `)
      .eq('status', 'published')
      .in('id', featuredArticleIds)
      .order('published_at', { ascending: false })
      .limit(3);
   
   featuredArticles = featuredArticlesData || [];
}

// Helper function untuk get alt text dari media_metadata
async function getAltText(thumbnailUrl: string | null): Promise<string | null> {
   if (!thumbnailUrl) return null;
   
   try {
      const { data: mediaMetadata } = await supabase
         .from('media_metadata')
         .select('alt_text')
         .eq('file_url', thumbnailUrl)
         .single();
      
      return mediaMetadata?.alt_text || null;
   } catch (e) {
      return null;
   }
}

// Get alt text untuk semua artikel dari media_metadata
const articlesWithAltText = await Promise.all(
   (featuredArticles || []).map(async (article: any) => {
      const altText = await getAltText(article.thumbnail_url);
      return {
         ...article,
         thumbnail_alt: altText,
      };
   })
);

// Fetch articles for list section with pagination
const page = parseInt(Astro.url.searchParams.get('page') || '1');
const limit = 10;
const offset = (page - 1) * limit;

// Get article_ids from article_tags for pagination
const { data: articleTags } = await supabase
   .from('article_tags')
   .select('article_id')
   .eq('tag_id', tag.id);

const articleIds = articleTags?.map((at: any) => at.article_id) || [];

let tagArticles: any[] = [];
let totalArticles = 0;

if (articleIds.length > 0) {
   const { data: tagArticlesData, error: tagArticlesError, count } = await supabase
      .from('articles')
      .select(`
         id,
         title,
         slug,
         summary,
         thumbnail_url,
         published_at,
         created_at,
         views_count,
         categories:category_id (
            id,
            name,
            slug
         )
      `, { count: 'exact' })
      .eq('status', 'published')
      .in('id', articleIds)
      .order('published_at', { ascending: false })
      .range(offset, offset + limit - 1);
   
   tagArticles = tagArticlesData || [];
   totalArticles = count || 0;
}

// Get alt text untuk semua artikel dari tag
const tagArticlesWithAltText = await Promise.all(
   (tagArticles || []).map(async (article: any) => {
      const altText = await getAltText(article.thumbnail_url);
      return {
         ...article,
         thumbnail_alt: altText,
      };
   })
);

const totalPages = Math.ceil(totalArticles / limit);

// Helper function to format time ago
function getTimeAgo(dateString: string | null): string {
   if (!dateString) return 'Baru saja';
   
   const date = new Date(dateString);
   const now = new Date();
   const diffInSeconds = Math.floor((now.getTime() - date.getTime()) / 1000);
   
   if (diffInSeconds < 60) return 'Baru saja';
   if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} menit yang lalu`;
   if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} jam yang lalu`;
   if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)} hari yang lalu`;
   if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 604800)} minggu yang lalu`;
   return `${Math.floor(diffInSeconds / 2592000)} bulan yang lalu`;
}

// Helper function untuk get category color
function getCategoryColor(categoryName: string): string {
   const colors: Record<string, string> = {
      'Ekonomi': 'from-blue-500 to-blue-600',
      'Saham': 'from-green-500 to-green-600',
      'Kripto': 'from-purple-500 to-purple-600',
      'Market': 'from-orange-500 to-orange-600',
      'Energi': 'from-yellow-500 to-yellow-600',
      'Sektor Riil': 'from-red-500 to-red-600',
      'Gaya Hidup': 'from-pink-500 to-pink-600',
   };
   return colors[categoryName] || 'from-gray-500 to-gray-600';
}
---

<Layout 
   title={pageTitle}
   description={pageDescription}
   keywords={`${tag.name}, berita ekonomi, saham, analisis pasar, SansStocks`}
>
   <Fragment slot="head">
      {/* Robots Meta */}
      <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1" />
      <meta name="googlebot" content="index, follow" />
      
      {/* Open Graph */}
      <meta property="og:type" content="website" />
      <meta property="og:title" content={pageTitle} />
      <meta property="og:description" content={pageDescription} />
      <meta property="og:image" content={pageImage} />
      <meta property="og:image:width" content="1200" />
      <meta property="og:image:height" content="630" />
      <meta property="og:url" content={tagUrl} />
      <meta property="og:site_name" content="SansStocks" />
      <meta property="og:locale" content="id_ID" />
      
      {/* Twitter Card */}
      <meta name="twitter:card" content="summary_large_image" />
      <meta name="twitter:title" content={pageTitle} />
      <meta name="twitter:description" content={pageDescription} />
      <meta name="twitter:image" content={pageImage} />
      
      {/* Canonical URL */}
      <link rel="canonical" href={tagUrl} />
      
      {/* Structured Data (JSON-LD) - CollectionPage */}
      <script type="application/ld+json" set:html={JSON.stringify({
         "@context": "https://schema.org",
         "@type": "CollectionPage",
         "name": tag.name,
         "description": pageDescription,
         "url": tagUrl,
         "mainEntity": {
            "@type": "ItemList",
            "numberOfItems": totalArticles || 0,
            "itemListElement": (tagArticlesWithAltText || []).slice(0, 10).map((article: any, index: number) => ({
               "@type": "ListItem",
               "position": index + 1,
               "item": {
                  "@type": "Article",
                  "@id": `${siteUrl}/artikel/${article.slug}`,
                  "headline": article.title,
                  "url": `${siteUrl}/artikel/${article.slug}`
               }
            }))
         }
      })} />
      
      {/* Structured Data (JSON-LD) - BreadcrumbList */}
      <script type="application/ld+json" set:html={JSON.stringify({
         "@context": "https://schema.org",
         "@type": "BreadcrumbList",
         "itemListElement": [
            {
               "@type": "ListItem",
               "position": 1,
               "name": "Beranda",
               "item": siteUrl
            },
            {
               "@type": "ListItem",
               "position": 2,
               "name": "Tag",
               "item": `${siteUrl}/tags`
            },
            {
               "@type": "ListItem",
               "position": 3,
               "name": tag.name,
               "item": tagUrl
            }
         ]
      })} />
   </Fragment>

   <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      {/* Breadcrumb Navigation */}
      <nav class="mb-6 text-sm text-gray-600">
         <a href="/" class="hover:text-gray-900">Beranda</a>
         <span class="mx-2">/</span>
         <a href="/tags" class="hover:text-gray-900">Tag</a>
         <span class="mx-2">/</span>
         <span class="text-gray-900">{tag.name}</span>
      </nav>

      <!-- Tag Header -->
      <div class="mb-8">
         <h1 class="text-4xl font-bold text-gray-900 mb-4">{tag.name}</h1>
         {tag.description && (
            <p class="text-lg text-gray-600">{tag.description}</p>
         )}
      </div>

      <!-- Featured Articles Section -->
      <section class="mb-16">
         <div class="grid lg:grid-cols-3 gap-6">
            {articlesWithAltText && articlesWithAltText.length > 0 ? (
               <>
                  {/* Featured Article - Large */}
                  <ArticleCard
                     title={articlesWithAltText[0].title}
                     excerpt={articlesWithAltText[0].summary || 'Tidak ada ringkasan tersedia...'}
                     category={(articlesWithAltText[0].categories as any)?.name || 'Artikel'}
                     categoryColor={getCategoryColor((articlesWithAltText[0].categories as any)?.name || 'Artikel')}
                     timeAgo={getTimeAgo(articlesWithAltText[0].published_at)}
                     author="Tim Editorial"
                     authorInitials="TE"
                     link={`/artikel/${articlesWithAltText[0].slug}`}
                     isLarge={true}
                     thumbnailUrl={articlesWithAltText[0].thumbnail_url}
                     thumbnailAlt={articlesWithAltText[0].thumbnail_alt}
                  />

                  {/* Side Articles */}
                  <div class="lg:col-span-1 flex flex-col gap-4">
                     {articlesWithAltText.slice(1, 3).map((article: any) => (
                        <ArticleCard
                           title={article.title}
                           excerpt={article.summary || 'Tidak ada ringkasan tersedia...'}
                           category={(article.categories as any)?.name || 'Artikel'}
                           categoryColor={getCategoryColor((article.categories as any)?.name || 'Artikel')}
                           timeAgo={getTimeAgo(article.published_at)}
                           author="Tim Editorial"
                           authorInitials="TE"
                           link={`/artikel/${article.slug}`}
                           thumbnailUrl={article.thumbnail_url}
                           thumbnailAlt={article.thumbnail_alt}
                           eagerLoad={true}
                        />
                     ))}
                  </div>
               </>
            ) : (
               <div class="lg:col-span-3 bg-white rounded-xl border border-gray-200 p-12 text-center">
                  <p class="text-gray-500 text-lg">Belum ada artikel dengan tag ini.</p>
                  <p class="text-gray-400 text-sm mt-2">Silakan publikasikan artikel dengan tag ini.</p>
               </div>
            )}
         </div>
      </section>

      <!-- Articles List Section -->
      <section class="mb-16">
         <div class="flex items-center justify-between mb-8">
            <h2 class="text-3xl font-bold text-gray-900">Artikel {tag.name}</h2>
         </div>
         
         <div class="grid lg:grid-cols-3 gap-8">
            <!-- Main News Content -->
            <div class="lg:col-span-2">
               <!-- News List with Pagination (Client-side) -->
               <NewsPagination 
                  client:load
                  initialPage={page}
                  initialArticles={tagArticlesWithAltText}
                  initialTotalPages={totalPages}
                  tagId={tag.id}
               />
            </div>
            
            <!-- Sidebar -->
            <div class="lg:col-span-1">
               <!-- Popular News Widget -->
               <PopularNews />

               <!-- Tag Info -->
               <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl border border-blue-200 p-6 mt-6">
                  <h4 class="text-lg font-bold text-gray-900 mb-2">Tentang Tag</h4>
                  <p class="text-sm text-gray-700 mb-4">
                     {tag.description || `Semua artikel dengan tag ${tag.name}.`}
                  </p>
                  <div class="text-xs text-gray-600">
                     <p class="font-medium">{totalArticles} artikel</p>
                  </div>
               </div>
            </div>
         </div>
      </section>
   </div>
</Layout>
