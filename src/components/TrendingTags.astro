---
export const prerender = false;

import { supabase } from '../db/supabase';

// Optimasi: Fetch popular tags dengan join query untuk menghindari multiple queries
// Menggunakan RPC atau query dengan aggregation jika tersedia
// Fallback ke approach yang lebih efisien dengan limit

// Fetch popular tags dengan join - lebih efisien
const { data: articleTagsWithDetails } = await supabase
  .from('article_tags')
  .select(`
    tag_id,
    tags:tag_id (
      id,
      name,
      slug
    )
  `)
  .limit(1000); // Limit untuk performa, cukup untuk menghitung popularitas

// Count tag usage dan collect tag details
const tagUsage: Record<number, { count: number; tag: any }> = {};
if (articleTagsWithDetails) {
  articleTagsWithDetails.forEach((at: any) => {
    const tagId = at.tag_id;
    if (!tagUsage[tagId]) {
      tagUsage[tagId] = {
        count: 0,
        tag: at.tags,
      };
    }
    tagUsage[tagId].count += 1;
  });
}

// Sort by usage count and get top 8
const trendingTags = Object.values(tagUsage)
  .filter((item) => item.tag !== null) // Filter out null tags
  .sort((a, b) => b.count - a.count)
  .slice(0, 8)
  .map((item) => ({
    id: item.tag.id,
    name: item.tag.name,
    slug: item.tag.slug,
    count: item.count,
  }));
---

<div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 mt-6">
  <h3 class="text-lg font-bold text-gray-900 mb-4">Tag Populer</h3>
  
  {trendingTags && trendingTags.length > 0 ? (
    <div class="flex flex-wrap gap-2">
      {trendingTags.map((tag: any) => (
        <a
          href={`/tags/${tag.slug}`}
          class="inline-flex items-center px-3 py-1.5 text-xs sm:text-sm font-medium text-gray-700 bg-gray-100 hover:bg-blue-100 hover:text-blue-700 rounded-full transition-colors"
        >
          #{tag.name}
       
        </a>
      ))}
    </div>
  ) : (
    <p class="text-sm text-gray-500">Belum ada tag populer.</p>
  )}
</div>

