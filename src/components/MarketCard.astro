---
import { Card, CardContent, CardHeader } from '@/components/ui/Card';

export interface Props {
	name: string;
	value: string;
	change: string;
	changeType: 'positive' | 'negative';
	iconColor: string;
	iconBgColor: string;
	symbol?: string; // Optional symbol untuk real-time update
}

const { name, value, change, changeType, iconColor, iconBgColor, symbol } = Astro.props;

const changeColor = changeType === 'positive' ? 'text-white bg-green-700' : 'text-white bg-red-700';
const changeIcon = changeType === 'positive' ? 'M7 11l5-5m0 0l5 5m-5-5v12' : 'M17 13l-5 5m0 0l-5-5m5 5V6';

// Convert style string to object for React component
const cardStyle = { minHeight: '140px' };
---

<Card className="group hover:shadow-lg transition-all duration-300 hover:-translate-y-1" style={cardStyle}>
	<CardHeader className="pb-3 sm:pb-4">
		<div class="flex justify-between items-start gap-2">
			<div class={`w-10 h-10 sm:w-12 sm:h-12 ${iconBgColor} rounded-lg flex items-center justify-center flex-shrink-0`}>
				<svg class={`w-5 h-5 sm:w-6 sm:h-6 ${iconColor}`} fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
					{changeType === 'positive' ? (
						<path stroke-linecap="round" stroke-linejoin="round" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
					) : (
						<path stroke-linecap="round" stroke-linejoin="round" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6" />
					)}
				</svg>
			</div>
			<span class={`px-2 sm:px-3 py-1 sm:py-1.5 ${changeColor} text-[10px] sm:text-xs font-bold rounded-full flex items-center gap-1 whitespace-nowrap`}>
				{change}
			</span>
		</div>
	</CardHeader>
	<CardContent className="pt-0">
		<div class="space-y-1.5 sm:space-y-2" data-market-card={symbol || ''}>
			<h3 class="text-xs sm:text-sm font-medium text-gray-700 uppercase tracking-wide">{name}</h3>
			<div class="text-2xl sm:text-3xl font-bold text-gray-900" data-value style="min-height: 2.5rem; height: 2.5rem; display: flex; align-items: center; contain: layout;">{value}</div>
			<div class="text-xs sm:text-sm text-gray-600" data-change style="min-height: 1rem; height: 1rem; display: flex; align-items: center; contain: layout;">{change}</div>
		</div>
	</CardContent>
</Card>

{symbol && (
	<script define:vars={{ symbolValue: String(symbol) }}>
		// Real-time update untuk market data
		(function() {
			const runtimeSymbol = symbolValue || '';
			if (!runtimeSymbol) return;
			
			const card = document.querySelector(`[data-market-card="${runtimeSymbol}"]`);
			if (!card) return;

			const valueEl = card.querySelector('[data-value]');
			const changeEl = card.querySelector('[data-change]');
			
			if (!valueEl || !changeEl) return;

			async function updateMarketData() {
				try {
					const response = await fetch(`/api/market?symbols=${runtimeSymbol}`);
					if (!response.ok) return;
					
					const result = await response.json();
					const dataArray = result && result.data;
					const marketData = Array.isArray(dataArray)
						? dataArray.find((item) => item && item.symbol === runtimeSymbol)
						: null;
					
					if (marketData) {
						// Update value dengan animasi
						if (valueEl.textContent !== marketData.value) {
							valueEl.style.transition = 'all 0.3s ease';
							valueEl.style.transform = 'scale(1.05)';
							setTimeout(() => {
								if (valueEl) {
									valueEl.textContent = marketData.value;
									valueEl.style.transform = 'scale(1)';
								}
							}, 150);
						}
						
						// Update change
						if (changeEl.textContent !== marketData.change) {
							changeEl.style.transition = 'all 0.3s ease';
							changeEl.style.opacity = '0.5';
							setTimeout(() => {
								if (changeEl) {
									changeEl.textContent = marketData.change;
									changeEl.style.opacity = '1';
								}
							}, 150);
						}
					}
				} catch (error) {
					console.error('Error updating market data:', error);
				}
			}

			// Update setiap 30 detik (bisa disesuaikan)
			const intervalId = setInterval(updateMarketData, 30000);
			
			// Cleanup saat component di-unmount
			if (typeof window !== 'undefined') {
				window.addEventListener('beforeunload', () => {
					clearInterval(intervalId);
				});
			}
		})();
	</script>
)}
