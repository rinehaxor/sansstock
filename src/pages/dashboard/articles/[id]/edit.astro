---
export const prerender = false;

import AdminLayout from '../../../../layouts/AdminLayout.astro';
import { supabase } from '../../../../db/supabase';

const accessToken = Astro.cookies.get('sb-access-token');
const refreshToken = Astro.cookies.get('sb-refresh-token');

if (!accessToken || !refreshToken) {
  return Astro.redirect('/portal/access');
}

let session;

try {
  session = await supabase.auth.setSession({
    refresh_token: refreshToken.value,
    access_token: accessToken.value,
  });

  if (session.error) {
    Astro.cookies.delete('sb-access-token', { path: '/' });
    Astro.cookies.delete('sb-refresh-token', { path: '/' });
    return Astro.redirect('/portal/access');
  }
} catch (error) {
  Astro.cookies.delete('sb-access-token', { path: '/' });
  Astro.cookies.delete('sb-refresh-token', { path: '/' });
  return Astro.redirect('/portal/access');
}

const email = session.data.user?.email;
const articleId = Astro.params.id;

// Fetch article
const { data: article, error: articleError } = await supabase
  .from('articles')
  .select(`
    *,
    article_tags (
      tag_id
    )
  `)
  .eq('id', articleId)
  .single();

if (articleError || !article) {
  return Astro.redirect('/dashboard/articles');
}

// Fetch categories, sources, and tags
const { data: categories } = await supabase
  .from('categories')
  .select('id, name')
  .order('name');

const { data: sources } = await supabase
  .from('sources')
  .select('id, name')
  .where('is_active', true)
  .order('name');

const { data: tags } = await supabase
  .from('tags')
  .select('id, name')
  .order('name');

// Get selected tag IDs
const selectedTagIds = article.article_tags?.map((at: any) => at.tag_id) || [];
---

<AdminLayout title="Edit Artikel" email={email}>
	<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
		<!-- Header -->
		<div class="mb-8">
			<div class="flex items-center justify-between">
				<div>
					<h1 class="text-3xl font-bold text-gray-900">Edit Artikel</h1>
					<p class="mt-2 text-sm text-gray-600">Ubah informasi artikel</p>
				</div>
				<a 
					href="/dashboard/articles"
					class="text-sm text-gray-600 hover:text-gray-900"
				>
					‚Üê Kembali ke Daftar Artikel
				</a>
			</div>
		</div>

		<!-- Form -->
		<form id="articleForm" class="bg-white shadow-sm rounded-lg border border-gray-200 p-6 space-y-6">
			<!-- Title -->
			<div>
				<label for="title" class="block text-sm font-medium text-gray-700 mb-2">
					Judul Artikel <span class="text-red-500">*</span>
				</label>
				<input 
					type="text" 
					id="title" 
					name="title" 
					value={article.title}
					required
					class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
				/>
			</div>

			<!-- Slug -->
			<div>
				<label for="slug" class="block text-sm font-medium text-gray-700 mb-2">
					Slug (URL) <span class="text-red-500">*</span>
				</label>
				<input 
					type="text" 
					id="slug" 
					name="slug" 
					value={article.slug}
					required
					data-original-value={article.slug}
					class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
				/>
			</div>

			<!-- Summary -->
			<div>
				<label for="summary" class="block text-sm font-medium text-gray-700 mb-2">
					Ringkasan
				</label>
				<textarea 
					id="summary" 
					name="summary" 
					rows="3"
					class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
				>{article.summary || ''}</textarea>
			</div>

			<!-- Content -->
			<div>
				<label for="content" class="block text-sm font-medium text-gray-700 mb-2">
					Konten <span class="text-red-500">*</span>
				</label>
				<textarea 
					id="content" 
					name="content" 
					rows="15"
					required
					class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-mono text-sm"
				>{article.content}</textarea>
			</div>

			<!-- Category & Source -->
			<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
				<div>
					<label for="category_id" class="block text-sm font-medium text-gray-700 mb-2">
						Kategori <span class="text-red-500">*</span>
					</label>
					<select 
						id="category_id" 
						name="category_id" 
						required
						class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
					>
						<option value="">Pilih Kategori</option>
						{categories && categories.map((cat) => (
							<option value={cat.id} selected={cat.id === article.category_id}>
								{cat.name}
							</option>
						))}
					</select>
				</div>

				<div>
					<label for="source_id" class="block text-sm font-medium text-gray-700 mb-2">
						Sumber
					</label>
					<select 
						id="source_id" 
						name="source_id"
						class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
					>
						<option value="">Pilih Sumber (Opsional)</option>
						{sources && sources.map((source) => (
							<option value={source.id} selected={source.id === article.source_id}>
								{source.name}
							</option>
						))}
					</select>
				</div>
			</div>

			<!-- Tags -->
			<div>
				<label class="block text-sm font-medium text-gray-700 mb-2">
					Tags
				</label>
				<div class="grid grid-cols-2 md:grid-cols-4 gap-2 max-h-40 overflow-y-auto border border-gray-200 rounded-lg p-3">
					{tags && tags.map((tag) => (
						<label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
							<input 
								type="checkbox" 
								name="tag_ids" 
								value={tag.id}
								checked={selectedTagIds.includes(tag.id)}
								class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
							/>
							<span class="text-sm text-gray-700">{tag.name}</span>
						</label>
					))}
				</div>
			</div>

			<!-- Thumbnail & Status -->
			<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
				<div>
					<label for="thumbnail_url" class="block text-sm font-medium text-gray-700 mb-2">
						URL Thumbnail
					</label>
					<input 
						type="url" 
						id="thumbnail_url" 
						name="thumbnail_url"
						value={article.thumbnail_url || ''}
						class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
					/>
				</div>

				<div>
					<label for="status" class="block text-sm font-medium text-gray-700 mb-2">
						Status
					</label>
					<select 
						id="status" 
						name="status"
						class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
					>
						<option value="draft" selected={article.status === 'draft'}>Draft</option>
						<option value="published" selected={article.status === 'published'}>Published</option>
						<option value="archived" selected={article.status === 'archived'}>Archived</option>
					</select>
				</div>
			</div>

			<!-- URL Original -->
			<div>
				<label for="url_original" class="block text-sm font-medium text-gray-700 mb-2">
					URL Original (jika disadur)
				</label>
				<input 
					type="url" 
					id="url_original" 
					name="url_original"
					value={article.url_original || ''}
					class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
				/>
			</div>

			<!-- Actions -->
			<div class="flex items-center justify-end gap-4 pt-6 border-t border-gray-200">
				<a 
					href="/dashboard/articles"
					class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 bg-white hover:bg-gray-50"
				>
					Batal
				</a>
				<button 
					type="submit"
					class="px-4 py-2 border border-transparent rounded-lg text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
				>
					Simpan Perubahan
				</button>
			</div>
		</form>
	</div>

	<script>
		const articleId = '{articleId}';

		// Handle form submission
		const form = document.getElementById('articleForm') as HTMLFormElement;
		form?.addEventListener('submit', async (e) => {
			e.preventDefault();

			const formData = new FormData(form);
			const tagCheckboxes = form.querySelectorAll('input[name="tag_ids"]:checked');
			const tagIds = Array.from(tagCheckboxes).map((cb: any) => parseInt(cb.value));

			const data = {
				title: formData.get('title'),
				slug: formData.get('slug'),
				summary: formData.get('summary') || null,
				content: formData.get('content'),
				thumbnail_url: formData.get('thumbnail_url') || null,
				category_id: parseInt(formData.get('category_id') as string),
				source_id: formData.get('source_id') ? parseInt(formData.get('source_id') as string) : null,
				status: formData.get('status') || 'draft',
				tag_ids: tagIds,
				url_original: formData.get('url_original') || null,
			};

			try {
				const response = await fetch(`/api/articles/${articleId}`, {
					method: 'PUT',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify(data),
					credentials: 'include',
				});

				if (response.ok) {
					alert('Artikel berhasil diperbarui!');
					window.location.href = '/dashboard/articles';
				} else {
					const error = await response.json();
					alert('Error: ' + (error.error || 'Gagal memperbarui artikel'));
				}
			} catch (error) {
				alert('Error: Gagal memperbarui artikel');
			}
		});
	</script>
</AdminLayout>

