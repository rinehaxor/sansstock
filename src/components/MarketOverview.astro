---
export const prerender = false;

import MarketCard from './MarketCard.astro';

interface MarketData {
	name: string;
	symbol: string;
	value: string;
	change: string;
	changePercent: number;
	changeType: 'positive' | 'negative';
}

// Fetch market data from API
let marketData: MarketData[] = [];
try {
	const response = await fetch(`${Astro.url.origin}/api/market`, {
		headers: {
			'Accept': 'application/json',
		},
	});
	
	if (response.ok) {
		const result = await response.json();
		marketData = result.data || [];
	}
} catch (error) {
	console.error('Error fetching market data:', error);
}

// Fallback to default data if API fails
const defaultMarketData: MarketData[] = [
	{
		name: 'IHSG',
		symbol: '^JKSE',
		value: '7,234.56',
		change: '+1.2%',
		changePercent: 1.2,
		changeType: 'positive',
	},
	{
		name: 'USD/IDR',
		symbol: 'IDR=X',
		value: '15,420',
		change: '-0.3%',
		changePercent: -0.3,
		changeType: 'negative',
	},
	{
		name: 'Bitcoin',
		symbol: 'BTC-USD',
		value: '$65,234',
		change: '+2.1%',
		changePercent: 2.1,
		changeType: 'positive',
	},
	{
		name: 'Emas',
		symbol: 'GC=F',
		value: '$2,045',
		change: '+0.8%',
		changePercent: 0.8,
		changeType: 'positive',
	},
];

const displayData = marketData.length > 0 ? marketData : defaultMarketData;

// Map symbols to icon colors
function getIconConfig(symbol: string, changeType: 'positive' | 'negative') {
	const configs: Record<string, { iconColor: string; iconBgColor: string }> = {
		'^JKSE': { iconColor: 'text-white', iconBgColor: 'bg-green-600' },
		'IDR=X': { iconColor: 'text-white', iconBgColor: changeType === 'positive' ? 'bg-green-600' : 'bg-red-600' },
		'BTC-USD': { iconColor: 'text-white', iconBgColor: 'bg-orange-600' },
		'GC=F': { iconColor: 'text-white', iconBgColor: 'bg-yellow-500' },
	};
	
	return configs[symbol] || { 
		iconColor: changeType === 'positive' ? 'text-white' : 'text-white', 
		iconBgColor: changeType === 'positive' ? 'bg-green-600' : 'bg-red-600' 
	};
}
---

<section class="mb-16">
	<div class="flex items-center justify-between mb-8">
		<h2 class="text-3xl font-bold text-gray-900">Ringkasan Pasar</h2>
		<a href="/pasar" class="text-blue-600 hover:text-blue-700 font-medium flex items-center group">
			Lihat Detail
			<svg class="w-4 h-4 ml-1 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
			</svg>
		</a>
	</div>
	<div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-6">
		{displayData.map((item) => {
			const iconConfig = getIconConfig(item.symbol, item.changeType);
			return (
		<MarketCard
					name={item.name}
					value={item.value}
					change={item.change}
					changeType={item.changeType}
					iconColor={iconConfig.iconColor}
					iconBgColor={iconConfig.iconBgColor}
		/>
			);
		})}
	</div>
</section>
