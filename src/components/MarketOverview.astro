---
export const prerender = false;

import MarketCard from './MarketCard.astro';
import { getMarketData } from '../lib/market';

interface MarketData {
	name: string;
	symbol: string;
	value: string;
	change: string;
	changePercent: number;
	changeType: 'positive' | 'negative';
}

// Fetch market data directly (optimasi: tanpa HTTP request internal)
let marketData: MarketData[] = [];
try {
	marketData = await getMarketData();
} catch (error) {
	console.error('Error fetching market data:', error);
	// Fallback akan di-handle oleh getMarketData
	marketData = await getMarketData(); // Retry dengan fallback
}

const displayData = marketData;

// Map symbols to icon colors
function getIconConfig(symbol: string, changeType: 'positive' | 'negative') {
	const configs: Record<string, { iconColor: string; iconBgColor: string }> = {
		'^JKSE': { iconColor: 'text-white', iconBgColor: 'bg-green-600' },
		'IDR=X': { iconColor: 'text-white', iconBgColor: changeType === 'positive' ? 'bg-green-600' : 'bg-red-600' },
		'BTC-USD': { iconColor: 'text-white', iconBgColor: 'bg-orange-600' },
		'GC=F': { iconColor: 'text-white', iconBgColor: 'bg-yellow-500' },
	};
	
	return configs[symbol] || { 
		iconColor: changeType === 'positive' ? 'text-white' : 'text-white', 
		iconBgColor: changeType === 'positive' ? 'bg-green-600' : 'bg-red-600' 
	};
}
---

<section class="mb-12 sm:mb-16">
	<div class="flex items-center justify-between mb-4 sm:mb-8">
		<h2 class="text-2xl sm:text-3xl font-bold text-gray-900">Ringkasan Pasar</h2>
		<a href="/pasar" class="text-blue-600 hover:text-blue-700 font-medium flex items-center group text-sm sm:text-base">
			<span class="hidden sm:inline">Lihat Detail</span>
			<span class="sm:hidden">Detail</span>
			<svg class="w-4 h-4 ml-1 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
			</svg>
		</a>
	</div>
	<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6">
		{displayData.map((item) => {
			const iconConfig = getIconConfig(item.symbol, item.changeType);
			return (
		<MarketCard
					name={item.name}
					value={item.value}
					change={item.change}
					changeType={item.changeType}
					iconColor={iconConfig.iconColor}
					iconBgColor={iconConfig.iconBgColor}
					symbol={item.symbol}
		/>
			);
		})}
	</div>
</section>
