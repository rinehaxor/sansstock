---
export const prerender = false;

import { supabase } from '../db/supabase';
import PopularNews from './PopularNews.astro';
import AdsWidget from './AdsWidget.astro';
import TrendingTags from './TrendingTags.astro';
import NewsPagination from './NewsPagination.tsx';
import { batchGetAltText } from '../lib/utils';

// Get page from URL query parameter
const page = parseInt(Astro.url.searchParams.get('page') || '1');
const limit = 10;
const offset = (page - 1) * limit;

// Fetch published articles with pagination for initial load
const { data: articles, error, count } = await supabase
  .from('articles')
  .select(`
    id,
    title,
    slug,
    summary,
    thumbnail_url,
    published_at,
    created_at,
    views_count,
    categories:category_id (
      id,
      name,
      slug
    )
  `, { count: 'exact' })
  .eq('status', 'published')
  .order('published_at', { ascending: false })
  .range(offset, offset + limit - 1);

// Calculate total pages
const totalArticles = count || 0;
const totalPages = Math.ceil(totalArticles / limit);

// Batch fetch alt text untuk semua artikel sekaligus (optimasi N+1 query)
const thumbnailUrls = (articles || []).map((article: any) => article.thumbnail_url);
const altTextMap = await batchGetAltText(thumbnailUrls);

// Map alt text ke artikel
const articlesWithAltText = (articles || []).map((article: any) => ({
  ...article,
  thumbnail_alt: article.thumbnail_url ? (altTextMap.get(article.thumbnail_url) || null) : null,
}));
---

<section class="mb-8 sm:mb-16">
	<div class="flex items-center justify-between mb-4 sm:mb-8">
		<h2 class="text-2xl sm:text-3xl font-bold text-gray-900">Terkini</h2>
		<a href="/artikel" class="text-blue-600 hover:text-blue-700 font-medium flex items-center group text-sm sm:text-base">
			<span class="hidden sm:inline">Lihat Semua</span>
			<span class="sm:hidden">Semua</span>
			<svg class="w-4 h-4 ml-1 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
			</svg>
		</a>
	</div>
	
	<div class="grid lg:grid-cols-3 gap-4 sm:gap-8">
		<!-- Main News Content -->
		<div class="lg:col-span-2">
			<!-- News List with Pagination (Client-side) -->
			<NewsPagination 
				client:visible
				initialPage={page}
				initialArticles={articlesWithAltText}
				initialTotalPages={totalPages}
			/>
		</div>
		
		<!-- Popular News Sidebar -->
		<div class="lg:col-span-1">
			<PopularNews />
			<AdsWidget />
			<TrendingTags />
		</div>
	</div>
</section>
