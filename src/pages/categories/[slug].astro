---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import { supabase } from '../../db/supabase';
import PopularNews from '../../components/PopularNews.astro';

const { slug } = Astro.params;

// Fetch category by slug
const { data: category, error: categoryError } = await supabase
   .from('categories')
   .select('id, name, slug, description')
   .eq('slug', slug)
   .single();

if (categoryError || !category) {
   return new Response('Category not found', { status: 404 });
}

// Fetch published articles from this category
const { data: articles, error: articlesError } = await supabase
   .from('articles')
   .select(`
      id,
      title,
      slug,
      summary,
      thumbnail_url,
      published_at,
      created_at,
      category_id,
      categories(name, slug)
   `)
   .eq('status', 'published')
   .eq('category_id', category.id)
   .order('published_at', { ascending: false })
   .limit(20);

// Helper function to format time ago
function getTimeAgo(dateString: string): string {
   const date = new Date(dateString);
   const now = new Date();
   const diffInSeconds = Math.floor((now.getTime() - date.getTime()) / 1000);

   if (diffInSeconds < 60) return 'Baru saja';
   if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} menit yang lalu`;
   if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} jam yang lalu`;
   if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)} hari yang lalu`;
   return date.toLocaleDateString('id-ID');
}
---

<Layout>
   <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Category Header -->
      <div class="mb-8">
         <h1 class="text-4xl font-bold text-gray-900 mb-4">{category.name}</h1>
         {category.description && (
            <p class="text-lg text-gray-600">{category.description}</p>
         )}
      </div>

      <div class="grid lg:grid-cols-3 gap-8">
         <!-- Main Articles List -->
         <div class="lg:col-span-2">
            {articles && articles.length > 0 ? (
               <div class="space-y-6">
                  {articles.map((article: any) => (
                     <article class="group bg-white rounded-xl border border-gray-200 p-6 hover:shadow-md transition-shadow">
                        <a href={`/artikel/${article.slug}`} class="flex gap-6">
                           {article.thumbnail_url && (
                              <div class="flex-shrink-0">
                                 <img 
                                    src={article.thumbnail_url} 
                                    alt={article.title}
                                    class="w-48 h-28 rounded-lg object-cover"
                                    loading="lazy"
                                 />
                              </div>
                           )}
                           <div class="flex-1 min-w-0">
                              <h3 class="text-xl font-bold text-gray-900 group-hover:text-blue-600 mb-2 leading-tight">
                                 {article.title}
                              </h3>
                              {article.summary && (
                                 <p class="text-sm text-gray-600 mb-3 line-clamp-2">
                                    {article.summary}
                                 </p>
                              )}
                              <p class="text-sm text-blue-600 font-medium">
                                 {article.categories?.name || category.name} | {getTimeAgo(article.published_at || article.created_at)}
                              </p>
                           </div>
                        </a>
                     </article>
                  ))}
               </div>
            ) : (
               <div class="bg-white rounded-xl border border-gray-200 p-12 text-center">
                  <p class="text-gray-500 text-lg">Belum ada artikel di kategori ini.</p>
               </div>
            )}
         </div>

         <!-- Sidebar -->
         <div class="lg:col-span-1">
            <!-- Popular News Widget -->
            <PopularNews />

            <!-- Category Info -->
            <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl border border-blue-200 p-6">
               <h4 class="text-lg font-bold text-gray-900 mb-2">Tentang Kategori</h4>
               <p class="text-sm text-gray-700 mb-4">
                  {category.description || `Semua artikel tentang ${category.name}.`}
               </p>
               <div class="text-xs text-gray-600">
                  <p class="font-medium">{articles?.length || 0} artikel</p>
               </div>
            </div>
         </div>
      </div>
   </div>
</Layout>

