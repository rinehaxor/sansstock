---
import ArticleCard from './ArticleCard.astro';
import { supabase } from '../db/supabase';
import { batchGetAltText } from '../lib/utils';

// Fetch featured articles
const { data: featuredArticles } = await supabase
  .from('articles')
  .select(`
    id,
    title,
    slug,
    summary,
    thumbnail_url,
    published_at,
    categories:category_id (
      id,
      name,
      slug
    )
  `)
  .eq('status', 'published')
  .eq('featured', true)
  .order('published_at', { ascending: false })
  .limit(3);

// Batch fetch alt text untuk semua artikel sekaligus (optimasi N+1 query)
const thumbnailUrls = (featuredArticles || []).map((article: any) => article.thumbnail_url);
const altTextMap = await batchGetAltText(thumbnailUrls);

// Map alt text ke artikel
const articlesWithAltText = (featuredArticles || []).map((article: any) => ({
  ...article,
  thumbnail_alt: article.thumbnail_url ? (altTextMap.get(article.thumbnail_url) || null) : null,
}));

// Helper function untuk format waktu relatif
function getTimeAgo(dateString: string | null): string {
  if (!dateString) return 'Baru saja';
  
  const date = new Date(dateString);
  const now = new Date();
  const diffInSeconds = Math.floor((now.getTime() - date.getTime()) / 1000);
  
  if (diffInSeconds < 60) return 'Baru saja';
  if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} menit yang lalu`;
  if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} jam yang lalu`;
  if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)} hari yang lalu`;
  if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 604800)} minggu yang lalu`;
  return `${Math.floor(diffInSeconds / 2592000)} bulan yang lalu`;
}

// Helper function untuk get category color
function getCategoryColor(categoryName: string): string {
  const colors: Record<string, string> = {
    'Ekonomi': 'from-blue-500 to-blue-600',
    'Saham': 'from-green-500 to-green-600',
    'Kripto': 'from-purple-500 to-purple-600',
    'Market': 'from-orange-500 to-orange-600',
    'Energi': 'from-yellow-500 to-yellow-600',
    'Sektor Riil': 'from-red-500 to-red-600',
    'Gaya Hidup': 'from-pink-500 to-pink-600',
  };
  return colors[categoryName] || 'from-gray-500 to-gray-600';
}
---

<section class="mb-16">
	<div class="grid lg:grid-cols-3 gap-6">
		{articlesWithAltText && articlesWithAltText.length > 0 ? (
			<>
				{/* Featured Article - Large */}
				<ArticleCard
					title={articlesWithAltText[0].title}
					excerpt={articlesWithAltText[0].summary || 'Tidak ada ringkasan tersedia...'}
					category={(articlesWithAltText[0].categories as any)?.name || 'Berita'}
					categoryColor={getCategoryColor((articlesWithAltText[0].categories as any)?.name || '')}
					timeAgo={getTimeAgo(articlesWithAltText[0].published_at)}
					author="Tim Editorial"
					authorInitials="TE"
					link={`/artikel/${articlesWithAltText[0].slug}`}
					isLarge={true}
					thumbnailUrl={articlesWithAltText[0].thumbnail_url}
					thumbnailAlt={articlesWithAltText[0].thumbnail_alt}
				/>

				{/* Side Articles */}
				<div class="lg:col-span-1 flex flex-col gap-4">
					{articlesWithAltText.slice(1, 3).map((article: any) => (
						<ArticleCard
							title={article.title}
							excerpt={article.summary || 'Tidak ada ringkasan tersedia...'}
							category={(article.categories as any)?.name || 'Berita'}
							categoryColor={getCategoryColor((article.categories as any)?.name || '')}
							timeAgo={getTimeAgo(article.published_at)}
							author="Tim Editorial"
							authorInitials="TE"
							link={`/artikel/${article.slug}`}
							thumbnailUrl={article.thumbnail_url}
							thumbnailAlt={article.thumbnail_alt}
							eagerLoad={true}
						/>
					))}
				</div>
			</>
		) : (
			<div class="lg:col-span-3 bg-white rounded-xl border border-gray-200 p-12 text-center">
				<p class="text-gray-500 text-lg">Belum ada artikel featured yang diterbitkan.</p>
				<p class="text-gray-400 text-sm mt-2">Silakan tandai artikel sebagai featured dari dashboard admin.</p>
			</div>
		)}
	</div>
</section>
