---
export const prerender = false;

import Layout from '../layouts/Layout.astro';
import MarketTicker from '../components/MarketTicker.astro';
import FeaturedNews from '../components/FeaturedNews.astro';
import MarketOverview from '../components/MarketOverview.astro';
import NewsList from '../components/NewsList.astro';
import CategoryTabs from '../components/CategoryTabs.tsx';
import { supabase } from '../db/supabase';

// Fetch categories for tabs
const { data: categories } = await supabase
  .from('categories')
  .select('id, name, slug, description')
  .order('name', { ascending: true });

// Filter categories that have published articles
const categoriesWithArticles = await Promise.all(
  (categories || []).map(async (category: any) => {
    const { data: articles } = await supabase
      .from('articles')
      .select('id')
      .eq('status', 'published')
      .eq('category_id', category.id)
      .limit(1);
    
    return articles && articles.length > 0 ? category : null;
  })
);

const availableCategories = categoriesWithArticles.filter((cat) => cat !== null);

// Site URL akan otomatis detect dari environment variable atau request
const siteUrl = import.meta.env.SITE_URL || Astro.site?.href || (Astro.url ? `${Astro.url.protocol}//${Astro.url.host}` : 'http://localhost:4321');
const pageTitle = 'EmitenHub - Berita Ekonomi & Analisis Pasar Terpercaya';
const pageDescription = 'Portal berita ekonomi, saham, dan analisis pasar terpercaya. Dapatkan insight terbaru tentang pasar modal Indonesia, analisis saham, dan berita ekonomi terkini.';
const pageImage = `${siteUrl}/logo.png`;
---

<Layout 
	title={pageTitle}
	description={pageDescription}
	keywords="berita ekonomi, saham, pasar modal, analisis finansial, investasi, IHSG, rupiah, ekonomi Indonesia"
>
	<Fragment slot="head">
		{/* Robots Meta */}
		<meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1" />
		<meta name="googlebot" content="index, follow" />
		
		{/* Open Graph */}
		<meta property="og:type" content="website" />
		<meta property="og:title" content={pageTitle} />
		<meta property="og:description" content={pageDescription} />
		<meta property="og:image" content={pageImage} />
		<meta property="og:image:width" content="1200" />
		<meta property="og:image:height" content="630" />
		<meta property="og:url" content={siteUrl} />
		<meta property="og:site_name" content="SansStocks" />
		<meta property="og:locale" content="id_ID" />
		
		{/* Twitter Card */}
		<meta name="twitter:card" content="summary_large_image" />
		<meta name="twitter:title" content={pageTitle} />
		<meta name="twitter:description" content={pageDescription} />
		<meta name="twitter:image" content={pageImage} />
		
		{/* Canonical URL */}
		<link rel="canonical" href={siteUrl} />
		
		{/* Author & Publisher */}
		<meta name="author" content="SansStocks" />
		<meta name="publisher" content="SansStocks" />
		
		{/* Structured Data (JSON-LD) - Organization */}
		<script type="application/ld+json" set:html={JSON.stringify({
			"@context": "https://schema.org",
			"@type": "Organization",
			"name": "EmitenHub",
			"url": siteUrl,
			"logo": {
				"@type": "ImageObject",
				"url": `${siteUrl}/logo.png`,
				"width": 200,
				"height": 200
			},
			"sameAs": []
		})} />
		
		{/* Structured Data (JSON-LD) - WebSite */}
		<script type="application/ld+json" set:html={JSON.stringify({
			"@context": "https://schema.org",
			"@type": "WebSite",
			"name": "EmitenHub",
			"url": siteUrl,
			"description": pageDescription,
			"publisher": {
				"@type": "Organization",
				"name": "EmitenHub"
			},
			"potentialAction": {
				"@type": "SearchAction",
				"target": {
					"@type": "EntryPoint",
					"urlTemplate": `${siteUrl}/artikel?search={search_term_string}`
				},
				"query-input": "required name=search_term_string"
			},
			"mainEntity": {
				"@type": "SiteNavigationElement",
				"name": "Main Navigation",
				"url": siteUrl,
				"hasPart": [
					{
						"@type": "SiteNavigationElement",
						"name": "Artikel",
						"url": `${siteUrl}/artikel`
					},
					...availableCategories.slice(0, 5).map((category: any) => ({
						"@type": "SiteNavigationElement",
						"name": category.name,
						"url": `${siteUrl}/categories/${category.slug}`,
						"description": category.description || `Semua artikel tentang ${category.name}`
					}))
				]
			}
		})} />
		
		{/* Structured Data (JSON-LD) - BreadcrumbList for Homepage */}
		<script type="application/ld+json" set:html={JSON.stringify({
			"@context": "https://schema.org",
			"@type": "BreadcrumbList",
			"itemListElement": [{
				"@type": "ListItem",
				"position": 1,
				"name": "Beranda",
				"item": siteUrl
			}]
		})} />
	</Fragment>

	<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
	<MarketTicker />
	<FeaturedNews />
	<MarketOverview />
	<CategoryTabs 
		client:load 
		categories={JSON.stringify(availableCategories)} 
	/>
	<NewsList />
	</div>
</Layout>
