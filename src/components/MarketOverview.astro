---
export const prerender = false;

import MarketCard from './MarketCard.astro';
import { getMarketData } from '../lib/market';

interface MarketData {
	name: string;
	symbol: string;
	value: string;
	change: string;
	changePercent: number;
	changeType: 'positive' | 'negative';
}

// Fetch market data directly (optimasi: tanpa HTTP request internal)
let marketData: MarketData[] = [];
try {
	marketData = await getMarketData();
} catch (error) {
	console.error('Error fetching market data:', error);
	// Fallback akan di-handle oleh getMarketData
	marketData = await getMarketData(); // Retry dengan fallback
}

const displayData = marketData;

// Map symbols to icon colors
// Icon background color harus mengikuti changeType (hijau untuk naik, merah untuk turun)
function getIconConfig(symbol: string, changeType: 'positive' | 'negative') {
	// Base icon color berdasarkan symbol (untuk identitas)
	const baseColors: Record<string, { iconColor: string; baseBgColor?: string }> = {
		'^JKSE': { iconColor: 'text-white' }, // IDX Composite - warna mengikuti changeType
		'IDR=X': { iconColor: 'text-white' }, // USD/IDR - warna mengikuti changeType
		'BTC-USD': { iconColor: 'text-white', baseBgColor: 'bg-orange-600' }, // Bitcoin - tetap orange
		'GC=F': { iconColor: 'text-white', baseBgColor: 'bg-yellow-500' }, // Gold - tetap yellow
	};
	
	const baseConfig = baseColors[symbol] || { iconColor: 'text-white' };
	
	// Jika ada baseBgColor, gunakan itu. Jika tidak, gunakan changeType
	const iconBgColor = baseConfig.baseBgColor 
		? baseConfig.baseBgColor 
		: (changeType === 'positive' ? 'bg-green-600' : 'bg-red-600');
	
	return {
		iconColor: baseConfig.iconColor,
		iconBgColor: iconBgColor,
	};
}
---

<section class="mb-12 sm:mb-16" style="min-height: 320px; contain: layout style paint;">
	<div class="flex items-center justify-between mb-4 sm:mb-8" style="min-height: 40px; height: 40px; contain: layout;">
		<h2 class="text-2xl sm:text-3xl font-bold text-gray-900">Ringkasan Pasar</h2>
		<a href="/categories/pasar" class="text-blue-600 hover:text-blue-700 font-medium flex items-center group text-sm sm:text-base">
			<span class="hidden sm:inline">Lihat Detail</span>
			<span class="sm:hidden">Detail</span>
			<svg class="w-4 h-4 ml-1 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
				<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
			</svg>
		</a>
	</div>
	<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6" style="min-height: 240px; contain: layout;">
		{displayData.map((item) => {
			const iconConfig = getIconConfig(item.symbol, item.changeType);
			return (
		<MarketCard
					name={item.name}
					value={item.value}
					change={item.change}
					changeType={item.changeType}
					iconColor={iconConfig.iconColor}
					iconBgColor={iconConfig.iconBgColor}
					symbol={item.symbol}
		/>
			);
		})}
	</div>
</section>
