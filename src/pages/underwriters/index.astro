---
export const prerender = false;

import Layout from '../../layouts/Layout.astro';
import { supabase } from '../../db/supabase';
import UnderwriterPerformance from '../../components/UnderwriterPerformance';

// Fetch all underwriters with their performance stats and IPO listings
const { data: underwriters, error } = await supabase
  .from('underwriters')
  .select(`
    id,
    name,
    created_at,
    ipo_underwriters:ipo_underwriters (
      ipo_listing:ipo_listings (
        id,
        ticker_symbol,
        company_name,
        ipo_date,
        ipo_price,
        general_sector,
        specific_sector,
        ipo_performance_metrics:ipo_performance_metrics (
          metric_name,
          metric_value,
          period_days
        )
      )
    )
  `)
  .order('name', { ascending: true });

// Calculate performance stats for each underwriter
let underwritersWithStats = [];
if (underwriters) {
  underwritersWithStats = underwriters.map((underwriter: any) => {
    const ipoUnderwriters = underwriter.ipo_underwriters || [];
    const ipoListings = ipoUnderwriters.map((item: any) => item.ipo_listing).filter((item: any) => item !== null);
    const allMetrics: any[] = [];

    ipoUnderwriters.forEach((item: any) => {
      const metrics = item.ipo_listing?.ipo_performance_metrics || [];
      allMetrics.push(...metrics);
    });

    // Group metrics by period_days
    const metricsByPeriod: Record<number, number[]> = {};
    allMetrics.forEach((metric: any) => {
      if (metric.period_days && metric.metric_value !== null) {
        if (!metricsByPeriod[metric.period_days]) {
          metricsByPeriod[metric.period_days] = [];
        }
        metricsByPeriod[metric.period_days].push(metric.metric_value);
      }
    });

    // Calculate averages, min, max for each period
    const performanceByPeriod: Record<number, { avg: number; min: number; max: number; count: number }> = {};
    Object.keys(metricsByPeriod).forEach((period) => {
      const values = metricsByPeriod[parseInt(period)];
      const avg = values.reduce((a, b) => a + b, 0) / values.length;
      performanceByPeriod[parseInt(period)] = {
        avg: parseFloat(avg.toFixed(2)),
        min: Math.min(...values),
        max: Math.max(...values),
        count: values.length,
      };
    });

    // Sort IPO listings by date (newest first)
    const sortedIpoListings = [...ipoListings].sort((a: any, b: any) => {
      return new Date(b.ipo_date).getTime() - new Date(a.ipo_date).getTime();
    });

    return {
      ...underwriter,
      total_ipos: ipoListings.length,
      performance_by_period: performanceByPeriod,
      ipo_listings: sortedIpoListings,
    };
  }).filter((u: any) => u.total_ipos > 0); // Only show underwriters with IPOs
}

// Sort by total IPOs descending by default
underwritersWithStats.sort((a: any, b: any) => b.total_ipos - a.total_ipos);
---

<Layout 
	title="History Underwriter IPO - Analisis Performa IPO BEI/IHSG"
	description="Lihat history dan performa IPO yang ditangani oleh berbagai underwriter di Bursa Efek Indonesia (BEI/IHSG). Analisis performa IPO berdasarkan periode waktu."
	keywords="underwriter IPO, history IPO, performa IPO, BEI, IHSG, Bursa Efek Indonesia, analisis IPO"
>
	<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
		<!-- Header -->
		<div class="mb-8">
			<div class="flex items-center gap-2 text-sm text-gray-500 mb-2">
				<a href="/" class="hover:text-gray-700">Beranda</a>
				<span>/</span>
				<span>Underwriter IPO</span>
			</div>
			<h1 class="text-4xl font-bold text-gray-900 mb-3">History Underwriter IPO</h1>
			<p class="text-lg text-gray-600 max-w-3xl">
				Analisis lengkap history dan performa IPO yang ditangani oleh berbagai underwriter di Bursa Efek Indonesia (BEI/IHSG). 
				Lihat track record, rata-rata performa, dan daftar IPO yang pernah ditangani.
			</p>
		</div>

		<!-- Stats Summary -->
		<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
			<div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-6 border border-blue-200">
				<div class="text-sm font-medium text-blue-700 mb-1">Total Underwriter</div>
				<div class="text-3xl font-bold text-blue-900">{underwritersWithStats.length}</div>
				<div class="text-xs text-blue-600 mt-1">Dengan history IPO</div>
			</div>
			<div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-6 border border-green-200">
				<div class="text-sm font-medium text-green-700 mb-1">Total IPO</div>
				<div class="text-3xl font-bold text-green-900">
					{underwritersWithStats.reduce((sum: number, uw: any) => sum + uw.total_ipos, 0)}
				</div>
				<div class="text-xs text-green-600 mt-1">Seluruh IPO yang ditangani</div>
			</div>
			<div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-6 border border-purple-200">
				<div class="text-sm font-medium text-purple-700 mb-1">Rata-rata IPO/Underwriter</div>
				<div class="text-3xl font-bold text-purple-900">
					{underwritersWithStats.length > 0 
						? Math.round(underwritersWithStats.reduce((sum: number, uw: any) => sum + uw.total_ipos, 0) / underwritersWithStats.length)
						: 0}
				</div>
				<div class="text-xs text-purple-600 mt-1">Per underwriter</div>
			</div>
		</div>

		<!-- Underwriter Performance -->
		<UnderwriterPerformance 
			client:load
			underwriters={JSON.stringify(underwritersWithStats || [])}
		/>
	</div>
</Layout>

