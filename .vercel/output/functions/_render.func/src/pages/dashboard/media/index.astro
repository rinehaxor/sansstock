---
export const prerender = false;

import AdminLayout from '../../../layouts/AdminLayout.astro';
import { supabase } from '../../../db/supabase';
import MediaLibrary from '../../../components/MediaLibrary.tsx';

const accessToken = Astro.cookies.get('sb-access-token');
const refreshToken = Astro.cookies.get('sb-refresh-token');

if (!accessToken || !refreshToken) {
  return Astro.redirect('/portal/access');
}

let session;

try {
  session = await supabase.auth.setSession({
    refresh_token: refreshToken.value,
    access_token: accessToken.value,
  });

  if (session.error) {
    Astro.cookies.delete('sb-access-token', { path: '/' });
    Astro.cookies.delete('sb-refresh-token', { path: '/' });
    return Astro.redirect('/portal/access');
  }
} catch (error) {
  Astro.cookies.delete('sb-access-token', { path: '/' });
  Astro.cookies.delete('sb-refresh-token', { path: '/' });
  return Astro.redirect('/portal/access');
}

const email = session.data.user?.email;
---

<AdminLayout title="Media Library" email={email}>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-8">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">Media Library</h1>
          <p class="mt-2 text-sm text-gray-600">Kelola semua gambar yang telah diupload</p>
        </div>
      </div>
    </div>

    <!-- Media Library Component -->
    <MediaLibrary client:load />
  </div>
</AdminLayout>

